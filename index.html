<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bharat Academic Copilot - Exam Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- PDF.js for reading PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Mammoth.js for reading Word documents -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        .animate-slide-in { animation: slideIn 0.5s ease-out; }

        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-accent {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .gradient-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .shadow-glow {
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.15);
        }

        .shadow-glow-accent {
            box-shadow: 0 20px 60px rgba(245, 87, 108, 0.15);
        }

        .text-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
            transform: translateY(-4px);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .page { display: none; }
        .page.active { display: block; }

        .badge-high { background: #fee2e2; color: #991b1b; }
        .badge-medium { background: #fef3c7; color: #92400e; }
        .badge-low { background: #dbeafe; color: #1e40af; }

        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%) !important;
        }
        body.dark-mode .bg-gradient-to-br { background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%) !important; }
        body.dark-mode .bg-white { background: #1e293b !important; }
        body.dark-mode .text-gray-700 { color: #e2e8f0 !important; }
        body.dark-mode .text-gray-600 { color: #cbd5e1 !important; }
        body.dark-mode .text-gray-900 { color: #f1f5f9 !important; }
        body.dark-mode .text-gray-500 { color: #94a3b8 !important; }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4, body.dark-mode h5, body.dark-mode h6 {
            color: #f1f5f9 !important;
        }
        body.dark-mode p { color: #cbd5e1 !important; }
        body.dark-mode .font-bold, body.dark-mode .font-semibold { color: #f1f5f9 !important; }
        body.dark-mode label { color: #e2e8f0 !important; }
        body.dark-mode .text-purple-600 { color: #c084fc !important; }
        body.dark-mode .text-red-600 { color: #f87171 !important; }
        body.dark-mode .text-green-600 { color: #4ade80 !important; }
        body.dark-mode .text-blue-600 { color: #60a5fa !important; }
        body.dark-mode .text-orange-600 { color: #fb923c !important; }
        body.dark-mode .text-pink-600 { color: #f472b6 !important; }
        body.dark-mode .border-gray-200 { border-color: #334155 !important; }
        body.dark-mode .bg-gray-200 { background: #334155 !important; color: #f1f5f9 !important; }
        body.dark-mode .text-gray-700 { color: #e2e8f0 !important; }
        body.dark-mode .hover\:bg-gray-300:hover { background: #475569 !important; }
        body.dark-mode button { color: inherit; }
        body.dark-mode .from-purple-50 { --tw-gradient-from: rgba(139, 92, 246, 0.1) !important; }
        body.dark-mode .to-pink-50 { --tw-gradient-to: rgba(236, 72, 153, 0.1) !important; }
        body.dark-mode .hover\:bg-gradient-to-r:hover { background: #334155 !important; }
        body.dark-mode nav button:hover { background: #334155 !important; }
        body.dark-mode .card {
            background: #1e293b !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6) !important;
            border: 1px solid #334155 !important;
        }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background: #0f172a !important;
            border-color: #475569 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode input::placeholder { color: #64748b !important; }
        body.dark-mode .hover\:bg-gray-100:hover { background: #334155 !important; }
        body.dark-mode .bg-gray-100 { background: #334155 !important; }
        body.dark-mode .bg-gray-50 { background: #1e293b !important; }
        body.dark-mode .hover\:bg-gray-50:hover { background: #334155 !important; }
        body.dark-mode .bg-purple-50 { background: rgba(139, 92, 246, 0.1) !important; }
        body.dark-mode .bg-blue-50 { background: rgba(59, 130, 246, 0.1) !important; }
        body.dark-mode .bg-green-50 { background: rgba(34, 197, 94, 0.1) !important; }
        body.dark-mode .bg-orange-50 { background: rgba(249, 115, 22, 0.1) !important; }
        body.dark-mode .bg-red-50 { background: rgba(239, 68, 68, 0.1) !important; }
        
        /* Fix days-left badge in dark mode */
        body.dark-mode .bg-orange-50.border-orange-200 { 
            background: #475569 !important; 
            border-color: #64748b !important; 
        }
        
        body.dark-mode .text-gradient { 
            background: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        body.dark-mode header { background: #1e293b !important; border-bottom: 1px solid #334155 !important; }
        body.dark-mode #sidebar { background: #1e293b !important; border-right: 1px solid #334155 !important; }
        body.dark-mode .border-b { border-color: #334155 !important; }
        body.dark-mode .border-t { border-color: #334155 !important; }
        body.dark-mode .border-l { border-color: #334155 !important; }
        body.dark-mode .border-r { border-color: #334155 !important; }
        body.dark-mode .border { border-color: #334155 !important; }
        body.dark-mode .border-2 { border-color: #475569 !important; }
        body.dark-mode .border-red-200 { border-color: rgba(239, 68, 68, 0.3) !important; background: rgba(239, 68, 68, 0.05) !important; }
        body.dark-mode .border-purple-200 { border-color: rgba(168, 85, 247, 0.3) !important; background: rgba(168, 85, 247, 0.05) !important; }
        body.dark-mode .border-blue-200 { border-color: rgba(59, 130, 246, 0.3) !important; background: rgba(59, 130, 246, 0.05) !important; }
        body.dark-mode .border-green-200 { border-color: rgba(34, 197, 94, 0.3) !important; background: rgba(34, 197, 94, 0.05) !important; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }
        body.dark-mode .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #cbd5e1;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.3s;
        }
        .toggle-switch.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::before { left: 27px; }

        /* Auth page specific styles */
        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Custom Notification Popup */
        .notification-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: white;
            padding: 32px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 320px;
            max-width: 90vw;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .notification-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }
        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }
        .notification-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        body.dark-mode .notification-popup {
            background: #1e293b;
            border: 1px solid #334155;
        }
        .notification-icon {
            font-size: 48px;
            margin-bottom: 16px;
            animation: bounceIn 0.5s ease;
        }
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Profile Dropdown */
        .profile-dropdown {
            position: absolute;
            top: 70px;
            right: 20px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            min-width: 280px;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 100;
        }

        /* Timetable Styles */
        .timetable-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; }
        .timetable-day { padding: 10px; border-radius: 12px; font-weight: 700; text-align: center; }
        .timetable-cell { min-height: 120px; border-radius: 12px; padding: 10px; border: 1px solid #e5e7eb; background: #f8fafc; }
        .timetable-session { padding: 8px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #e5e7eb; background: #ffffff; }
        .timetable-session.bg-green-300 { background-color: #16a34a !important; border-color: #15803d !important; border-width: 2px !important; color: #ffffff !important; }
        .timetable-session.bg-green-300 p { color: #ffffff !important; }
        .day-mon { background: #fecaca; }
        .day-tue { background: #fed7aa; }
        .day-wed { background: #fde68a; }
        .day-thu { background: #bbf7d0; }
        .day-fri { background: #bfdbfe; }
        .day-sat { background: #ddd6fe; }
        .day-sun { background: #fbcfe8; }
        body.dark-mode .timetable-cell { background: #1e293b !important; border-color: #334155 !important; }
        body.dark-mode .timetable-session { background: #0f172a !important; border-color: #475569 !important; color: #e2e8f0 !important; }
        body.dark-mode .timetable-session.bg-green-300 { background: #16a34a !important; color: #ffffff !important; border-color: #15803d !important; border-width: 2px !important; }
        body.dark-mode .timetable-session.bg-green-300 p { color: #ffffff !important; }
        body.dark-mode .timetable-day { color: #f1f5f9 !important; border: 1px solid #334155; }
        body.dark-mode .day-mon { background: rgba(239, 68, 68, 0.15) !important; }
        body.dark-mode .day-tue { background: rgba(249, 115, 22, 0.15) !important; }
        body.dark-mode .day-wed { background: rgba(234, 179, 8, 0.15) !important; }
        body.dark-mode .day-thu { background: rgba(34, 197, 94, 0.15) !important; }
        body.dark-mode .day-fri { background: rgba(59, 130, 246, 0.15) !important; }
        body.dark-mode .day-sat { background: rgba(168, 85, 247, 0.15) !important; }
        body.dark-mode .day-sun { background: rgba(236, 72, 153, 0.15) !important; }
        .profile-dropdown.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        body.dark-mode .profile-dropdown {
            background: #1e293b !important;
            border: 1px solid #475569 !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6) !important;
        }
        body.dark-mode .profile-dropdown h3 {
            color: #f1f5f9 !important;
        }
        body.dark-mode .profile-dropdown p {
            color: #cbd5e1 !important;
        }
        body.dark-mode .profile-dropdown button {
            color: #e2e8f0 !important;
        }
        body.dark-mode .profile-dropdown button:hover {
            background: #334155 !important;
        }
        body.dark-mode .profile-dropdown .text-red-600 {
            color: #fca5a5 !important;
        }
        body.dark-mode .profile-dropdown .hover\:bg-red-50:hover {
            background: rgba(239, 68, 68, 0.1) !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-purple-50 to-slate-100">
    <!-- Notification Overlay -->
    <div id="notification-overlay" class="notification-overlay"></div>
    
    <!-- Notification Popup -->
    <div id="notification-popup" class="notification-popup">
        <div class="text-center">
            <div id="notification-icon" class="notification-icon">‚úÖ</div>
            <h3 id="notification-title" class="text-2xl font-bold mb-2 text-gray-900">Success!</h3>
            <p id="notification-message" class="text-gray-600 mb-6">Operation completed successfully</p>
            <button onclick="closeNotification()" class="gradient-primary text-white px-8 py-3 rounded-lg font-bold hover:shadow-glow transition-all">OK</button>
        </div>
    </div>

    <!-- Exam Date Input Modal -->
    <div id="exam-date-overlay" class="notification-overlay"></div>
    <div id="exam-date-modal" class="notification-popup">
        <div class="text-center">
            <div class="notification-icon">üìÖ</div>
            <h3 class="text-2xl font-bold mb-2 text-gray-900">Set Your Exam Date</h3>
            <p class="text-gray-600 mb-6">Enter your exam date to start countdown</p>
            <input type="date" id="exam-date-input" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-6 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center text-lg">
            <div class="flex gap-3">
                <button onclick="cancelExamDate()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition-all">Cancel</button>
                <button onclick="confirmExamDate()" class="flex-1 gradient-primary text-white px-6 py-3 rounded-lg font-bold hover:shadow-glow transition-all">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Clear History Confirmation Modal -->
    <div id="clear-confirm-overlay" class="notification-overlay"></div>
    <div id="clear-confirm-modal" class="notification-popup" style="max-width: 550px;">
        <div class="text-center">
            <div class="notification-icon text-orange-500">‚ö†Ô∏è</div>
            <h3 class="text-2xl font-bold mb-3 text-gray-900">Clear Q&A Session History?</h3>
            <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-4 text-left rounded-lg">
                <p class="text-sm font-semibold text-orange-800 mb-2">‚ö†Ô∏è What will be cleared:</p>
                <p class="text-sm text-orange-700 mb-2">‚Ä¢ All generated questions and answers from this screen</p>
                <p class="text-sm text-orange-700">‚Ä¢ Q&A session history for this subject</p>
            </div>
            <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 text-left rounded-lg">
                <p class="text-sm font-semibold text-green-800 mb-2">‚úÖ What will NOT be affected:</p>
                <p class="text-sm text-green-700 mb-2">‚Ä¢ Your uploaded files (syllabus, papers, notes)</p>
                <p class="text-sm text-green-700 mb-2">‚Ä¢ Subject topics and analysis data</p>
                <p class="text-sm text-green-700">‚Ä¢ Study plans and schedules</p>
            </div>
            <p class="text-sm text-gray-600 mb-6">üí° Tip: Download as PDF before clearing if you want to save this session</p>
            <div class="flex gap-3">
                <button onclick="cancelClearHistory()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition-all">Cancel</button>
                <button onclick="confirmClearHistory()" class="flex-1 bg-gradient-to-r from-red-500 to-orange-500 text-white px-6 py-3 rounded-lg font-bold hover:shadow-glow transition-all">Yes, Clear It</button>
            </div>
        </div>
    </div>

    <!-- Session Completion Confirmation Modal -->
    <div id="session-complete-overlay" class="notification-overlay"></div>
    <div id="session-complete-modal" class="notification-popup" style="max-width: 450px;">
        <div class="text-center">
            <div class="notification-icon text-blue-500">‚úÖ</div>
            <h3 class="text-2xl font-bold mb-3 text-gray-900">Mark Session as Completed?</h3>
            <p id="session-complete-details" class="text-gray-600 mb-6"></p>
            <div class="flex gap-3">
                <button onclick="cancelSessionCompletion()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition-all">‚úó Not Yet</button>
                <button onclick="confirmSessionCompletion()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-lg font-bold hover:shadow-glow transition-all">‚úì Completed</button>
            </div>
        </div>
    </div>

    <!-- Authentication Page -->
    <div id="auth-page" class="auth-page">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full mx-4 p-8">
            <div class="text-center mb-8">
                <div class="gradient-primary w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-3xl">üéì</span>
                </div>
                <h1 class="text-3xl font-bold text-gradient mb-2">Bharat Academic Copilot</h1>
                <p class="text-gray-600">Your AI-powered exam success partner</p>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="space-y-4">
                <h2 class="text-2xl font-bold mb-6 text-center">Welcome Back!</h2>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Email or Username</label>
                    <input type="text" id="login-email" placeholder="Enter your email or username" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" 
                           onkeypress="if(event.key==='Enter') handleLogin()"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div class="flex items-center justify-between text-sm">
                    <label class="flex items-center">
                        <input type="checkbox" class="mr-2">
                        <span class="text-gray-600">Remember me</span>
                    </label>
                    <a href="#" class="text-purple-600 font-semibold hover:underline">Forgot Password?</a>
                </div>
                <button onclick="handleLogin()" class="w-full gradient-primary text-white py-3 rounded-lg font-bold hover:shadow-glow transition-all">Login</button>
                <p class="text-center text-sm text-gray-600">Don't have an account? <button onclick="showSignup()" class="text-purple-600 font-semibold hover:underline">Sign Up</button></p>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" class="space-y-4" style="display: none;">
                <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Full Name</label>
                    <input type="text" id="signup-name" placeholder="Enter your full name" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Username</label>
                    <input type="text" id="signup-username" placeholder="Choose a username" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Password</label>
                    <input type="password" id="signup-password" placeholder="Create a password" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Exam Date</label>
                    <input type="date" id="signup-exam-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <label class="flex items-start text-sm">
                    <input type="checkbox" id="signup-terms" class="mr-2 mt-1">
                    <span class="text-gray-600">I agree to the Terms of Service and Privacy Policy</span>
                </label>
                <button onclick="handleSignup()" class="w-full gradient-primary text-white py-3 rounded-lg font-bold hover:shadow-glow transition-all">Create Account</button>
                <p class="text-center text-sm text-gray-600">Already have an account? <button onclick="showLogin()" class="text-purple-600 font-semibold hover:underline">Login</button></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="flex h-screen overflow-hidden" style="display: none;">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 shadow-glow fixed md:relative h-screen overflow-y-auto transform md:translate-x-0 transition-transform duration-300 z-40 bg-white" style="border-right: 1px solid #e5e7eb;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="gradient-primary w-10 h-10 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">üéì</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gradient">Bharat</h1>
                        <p class="text-xs text-gray-500">Academic Copilot</p>
                    </div>
                </div>
            </div>

            <nav class="p-4 space-y-2">
                <button onclick="goToPage('dashboard')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gradient-to-r from-purple-50 to-pink-50 transition-all group text-left">
                    <span>üè†</span>
                    <span class="font-medium text-gray-700">Dashboard</span>
                </button>
                <button onclick="goToPage('analysis')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gradient-to-r from-purple-50 to-pink-50 transition-all group text-left">
                    <span>üìä</span>
                    <span class="font-medium text-gray-700">Analysis</span>
                </button>
                <button onclick="goToPage('answers')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gradient-to-r from-purple-50 to-pink-50 transition-all group text-left">
                    <span>üìù</span>
                    <span class="font-medium text-gray-700">Q&A's</span>
                </button>
                <button onclick="goToPage('planner')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gradient-to-r from-purple-50 to-pink-50 transition-all group text-left">
                    <span>üìÖ</span>
                    <span class="font-medium text-gray-700">Study Schedule</span>
                </button>
                <button onclick="goToPage('upload')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gradient-to-r from-purple-50 to-pink-50 transition-all group text-left">
                    <span>‚¨ÜÔ∏è</span>
                    <span class="font-medium text-gray-700">Upload Files</span>
                </button>
            </nav>

            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 space-y-2 bg-white">
                <button onclick="openSettings()" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors text-gray-700">
                    <span>‚öôÔ∏è</span>
                    <span class="font-medium">Settings</span>
                </button>
                <div class="gradient-primary rounded-lg p-4 text-white text-sm">
                    <p class="font-bold mb-2">Quick Tip üí°</p>
                    <p class="text-xs">Upload your syllabus and past papers!</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden w-full md:w-auto">
            <!-- Header -->
            <header class="bg-white shadow-glow sticky top-0 z-20">
                <div class="px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleSidebar()" class="md:hidden p-2 hover:bg-gray-100 rounded-lg">‚ò∞</button>
                        <h1 class="text-2xl font-bold text-gradient hidden md:block">Bharat Academic Copilot</h1>
                        <h1 class="text-lg font-bold text-gradient md:hidden">BAC</h1>
                    </div>

                    <div class="flex items-center space-x-4">
                        <div id="days-left-badge" class="hidden sm:flex items-center space-x-2 px-4 py-2 bg-slate-700/90 rounded-lg border border-slate-600">
                            <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                            <span id="days-left-text" class="text-xs font-semibold text-white">15 days left</span>
                        </div>

                        <div class="relative">
                            <button id="notification-bell" onclick="showMotivation()" onmouseenter="showNotificationPanel()" onmouseleave="hideNotificationPanel()" class="relative p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">üîî
                                <span id="notification-badge" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                            </button>
                            
                            <!-- Notification Panel -->
                            <div id="notification-panel" class="profile-dropdown" style="right: 0; min-width: 320px; display: none;">
                                <div class="mb-3">
                                    <h3 class="font-bold text-gray-900 mb-2">üìÖ Today's Sessions</h3>
                                </div>
                                <div id="notification-sessions-list" class="space-y-2 max-h-64 overflow-y-auto">
                                    <p class="text-xs text-gray-500">No sessions scheduled for today</p>
                                </div>
                            </div>
                        </div>

                        <div class="relative">
                            <button onclick="toggleProfileDropdown()" class="flex items-center space-x-3 pl-4 border-l border-white/20 hover:bg-white/10 rounded-lg pr-2 py-1 transition-colors">
                                <div id="user-avatar" class="gradient-primary w-10 h-10 rounded-full flex items-center justify-center text-white font-bold cursor-pointer">S</div>
                                <div class="hidden sm:block">
                                    <p id="user-display-name" class="text-sm font-semibold text-gray-900">Student</p>
                                    <p id="user-subject" class="text-xs text-white font-semibold">Mathematics</p>
                                </div>
                            </button>
                            
                            <!-- Profile Dropdown -->
                            <div id="profile-dropdown" class="profile-dropdown">
                                <div class="text-center mb-4">
                                    <div id="dropdown-avatar" class="gradient-primary w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-2xl mx-auto mb-3">S</div>
                                    <h3 id="dropdown-name" class="font-bold text-lg text-gray-900">Student Name</h3>
                                    <p id="dropdown-username" class="text-sm text-gray-600 mb-1">@username</p>
                                    <p id="dropdown-subject" class="text-xs text-gray-500">Mathematics</p>
                                </div>
                                <div class="border-t border-gray-200 pt-3 space-y-2">
                                    <button onclick="openProfileSettings(); toggleProfileDropdown();" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded-lg text-sm transition-colors">
                                        ‚öôÔ∏è Edit Profile
                                    </button>
                                    <button onclick="handleLogout()" class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600 rounded-lg text-sm transition-colors">
                                        üö™ Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Pages -->
            <main class="flex-1 overflow-auto bg-gradient-to-br from-slate-50 via-purple-50 to-slate-100">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active p-6 space-y-8 animate-fade-in max-w-7xl mx-auto">
                    <div class="gradient-primary rounded-2xl p-8 text-white shadow-glow">
                        <h1 class="text-4xl font-bold mb-2">Hey, Student! üëã</h1>
                        <p class="text-lg opacity-90 mb-4">Let's conquer your Mathematics exam in 15 days</p>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="startExamMode()" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-semibold hover:shadow-lg">Start Exam Mode</button>
                            <button onclick="viewSyllabus()" class="border-2 border-white text-white px-6 py-2 rounded-lg font-semibold hover:bg-white hover:bg-opacity-10">View Syllabus</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card bg-gradient-to-br from-slate-800 to-slate-900 border-2 border-slate-700">
                            <p class="text-gray-300 text-sm mb-3 font-semibold">üìö Your Subjects</p>
                            <div id="dash-subjects-list" class="space-y-2">
                                <p class="text-gray-400 text-xs">No subjects yet</p>
                            </div>
                        </div>
                        <div class="card bg-gradient-to-br from-blue-600 to-indigo-700 border-2 border-blue-500"><p class="text-blue-100 text-sm mb-2 font-semibold">‚ú® Time Well Spent</p><p id="dash-hours" class="text-4xl font-bold text-white">0h 0m</p></div>
                    </div>

                    <!-- Features Overview Section -->
                    <div class="card bg-gradient-to-br from-slate-50 to-blue-50 border-2 border-blue-100">
                        <div class="text-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">üöÄ Your AI-Powered Study Companion</h2>
                            <p class="text-gray-600">Everything you need to ace your exams in one place</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Feature 1 -->
                            <div class="bg-white p-5 rounded-xl border-2 border-purple-200 hover:shadow-lg transition-all">
                                <div class="text-4xl mb-3">üì§</div>
                                <h3 class="font-bold text-gray-900 mb-2">Upload Materials</h3>
                                <p class="text-xs text-gray-600">Upload syllabus, past papers & notes for AI analysis</p>
                            </div>

                            <!-- Feature 2 -->
                            <div class="bg-white p-5 rounded-xl border-2 border-blue-200 hover:shadow-lg transition-all">
                                <div class="text-4xl mb-3">üìä</div>
                                <h3 class="font-bold text-gray-900 mb-2">Smart Analysis</h3>
                                <p class="text-xs text-gray-600">Get AI-powered insights on high-priority topics</p>
                            </div>

                            <!-- Feature 3 -->
                            <div class="bg-white p-5 rounded-xl border-2 border-green-200 hover:shadow-lg transition-all">
                                <div class="text-4xl mb-3">üìã</div>
                                <h3 class="font-bold text-gray-900 mb-2">Generate Answers</h3>
                                <p class="text-xs text-gray-600">AI creates exam-ready answers by marks & type</p>
                            </div>

                            <!-- Feature 4 -->
                            <div class="bg-white p-5 rounded-xl border-2 border-orange-200 hover:shadow-lg transition-all">
                                <div class="text-4xl mb-3">üìÖ</div>
                                <h3 class="font-bold text-gray-900 mb-2">Plan Schedule</h3>
                                <p class="text-xs text-gray-600">Create personalized study timetables & track progress</p>
                            </div>
                        </div>

                        <div class="mt-6 p-4 bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg border border-purple-200">
                            <div class="flex items-start gap-3">
                                <div class="text-2xl">üí°</div>
                                <div>
                                    <h4 class="font-bold text-gray-900 mb-1">Quick Start Guide:</h4>
                                    <ol class="text-sm text-gray-700 space-y-1">
                                        <li><strong>1.</strong> Add your subjects and upload study materials</li>
                                        <li><strong>2.</strong> View AI analysis of important topics</li>
                                        <li><strong>3.</strong> Generate practice answers for different marks</li>
                                        <li><strong>4.</strong> Create and track your study schedule</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div onclick="handleGenerateAnswers()" class="card gradient-accent text-white p-8 rounded-2xl cursor-pointer hover:shadow-glow-accent"><h3 class="text-xl font-bold mb-2">üìã Generate Exam Answers</h3><p class="opacity-90">Get AI-powered answers optimized for your university exam pattern</p></div>
                        <div onclick="goToPage('planner')" class="card gradient-success text-white p-8 rounded-2xl cursor-pointer hover:shadow-glow"><h3 class="text-xl font-bold mb-2">üìÖ Create Study Schedule</h3><p class="opacity-90">Get a personalized day-wise revision schedule</p></div>
                    </div>
                </div>

                <!-- Analysis Page -->
                <div id="analysis" class="page p-6 animate-fade-in max-w-7xl mx-auto">
                    <h1 class="text-3xl font-bold mb-2">üìä Exam Pattern Analysis</h1>
                    <p class="text-gray-600 mb-6">AI-powered topic intelligence based on past papers</p>

                    <!-- Subject Selector -->
                    <div class="card mb-6">
                        <label class="text-sm font-bold mb-3 block">üìö Select Subject</label>
                        <select id="analysis-subject-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            <option value="">Select a subject</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="card"><p class="text-sm text-gray-600 mb-1">Total Topics</p><p id="analysis-topics" class="text-3xl font-bold text-purple-600">0</p></div>
                        <div class="card"><p class="text-sm text-gray-600 mb-1">High Priority</p><p id="analysis-priority" class="text-3xl font-bold text-red-600">0</p></div>
                        <div class="card"><p class="text-sm text-gray-600 mb-1">Avg. Coverage</p><p id="analysis-coverage" class="text-3xl font-bold text-green-600">0%</p></div>
                    </div>

                    <!-- Dynamic Topics Display -->
                    <div id="analysis-topics-container" class="mb-6">
                        <!-- Core Topics Section -->
                        <div class="card mb-6">
                            <h2 class="text-xl font-bold mb-4 flex items-center">üìö Core Topics (from uploaded materials)</h2>
                            <div id="core-topics-list" class="space-y-3">
                                <p class="text-gray-500 text-sm">Select a subject to view topics</p>
                            </div>
                        </div>

                        <!-- Topics Analysis Section -->
                        <div class="card">
                            <h2 class="text-xl font-bold mb-4 flex items-center">üìä Detailed Topic Analysis</h2>
                            <div id="detailed-analysis" class="space-y-6">
                                <!-- Most Important Topics -->
                                <div>
                                    <h3 class="text-lg font-semibold text-red-600 mb-3">‚≠ê Most Important Topics</h3>
                                    <div id="important-topics" class="space-y-2">
                                        <p class="text-gray-500 text-sm">Select a subject to view</p>
                                    </div>
                                </div>

                                <!-- Subtopics Breakdown -->
                                <div>
                                    <h3 class="text-lg font-semibold text-purple-600 mb-3">üîó Subtopics & Connected Topics</h3>
                                    <div id="subtopics-list" class="space-y-2">
                                        <p class="text-gray-500 text-sm">Select a subject to view</p>
                                    </div>
                                </div>

                                <!-- Least Important Topics -->
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-600 mb-3">üìç Reference Topics (Low Priority)</h3>
                                    <div id="low-priority-topics" class="space-y-2">
                                        <p class="text-gray-500 text-sm">Select a subject to view</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Smart Study Recommendation Section -->
                    <div class="card border-2 border-purple-200 mb-6">
                        <h3 class="font-bold mb-2 text-lg">üí° Generate Study Plan</h3>
                        <p class="text-gray-700 mb-4">Create a personalized study schedule based on topic importance and your exam date</p>
                        <button onclick="generateSmartRecommendation()" class="mt-4 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg font-semibold hover:shadow-glow">üìÖ Generate Study Schedule</button>
                    </div>

                    <!-- Recommendation Display Area -->
                    <div id="recommendation-display" style="display: none;"></div>
                </div>

                <!-- Answers Page -->
                <div id="answers" class="page p-6 animate-fade-in max-w-7xl mx-auto">
                    <h1 class="text-3xl font-bold mb-2">‚úçÔ∏è Exam-Ready Answer Generator</h1>
                    <p class="text-gray-600 mb-6">AI-generated answers optimized for your university evaluators</p>

                    <!-- Subject and Topic Selectors -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="card">
                            <label class="text-sm font-bold mb-3 block">üìö Select Subject</label>
                            <select id="answers-subject-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="">Select a subject</option>
                            </select>
                        </div>
                        <div class="card">
                            <label class="text-sm font-bold mb-3 block">üéØ Select Topic</label>
                            <select id="answers-topic-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="">Choose a subject first</option>
                            </select>
                        </div>
                    </div>

                    <!-- Marks and Question Type -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="card">
                            <div class="flex items-center justify-between mb-3">
                                <label class="text-sm font-bold">‚≠ê Select Marks</label>
                                <button onclick="openMarksEditor()" class="text-lg hover:scale-110 transition-transform" title="Edit custom marks">‚úèÔ∏è</button>
                            </div>
                            <div id="answers-marks-container" class="space-y-2">
                                <button onclick="selectAnswerMarks(5)" class="w-full px-4 py-3 bg-gray-100 rounded-lg">5 Marks</button>
                                <button onclick="selectAnswerMarks(10)" class="w-full px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg">10 Marks</button>
                                <button onclick="selectAnswerMarks(15)" class="w-full px-4 py-3 bg-gray-100 rounded-lg">15 Marks</button>
                            </div>
                        </div>

                        <div class="card">
                            <label class="text-sm font-bold mb-3 block">‚ùì Question Type</label>
                            <div class="space-y-2">
                                <button onclick="selectAnswerType('mcq')" id="btn-type-mcq" class="w-full px-4 py-3 bg-gray-100 rounded-lg hover:bg-blue-100">Multiple Choice (MCQ)</button>
                                <button onclick="selectAnswerType('long')" id="btn-type-long" class="w-full px-4 py-3 bg-gray-100 rounded-lg hover:bg-green-100">Long Answer</button>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="card text-center mb-6">
                        <button id="generate-btn" onclick="generateAnswer()" class="w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg font-bold text-lg hover:shadow-glow">üöÄ Generate Question and Answers</button>
                        
                        <!-- Loading Indicator -->
                        <div id="answer-loading" style="display: none;" class="mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full animate-pulse" style="width: 100%"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2 animate-pulse">ü§ñ AI is generating your exam-ready Q&A...</p>
                        </div>
                    </div>

                    <!-- Question and Answer Display -->
                    <div id="answers-qa-display" style="display: none;">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="card border-2 border-blue-200" style="background-color: #f0f8ff;">
                                <p class="text-sm font-bold mb-2">‚ùì Question</p>
                                <p id="display-question" class="text-gray-700"></p>
                            </div>
                            <div class="card border-2 border-green-200" style="background-color: #f0fdf4;">
                                <p class="text-sm font-bold mb-2">‚úì Optimized Answer</p>
                                <p id="display-answer" class="text-sm text-gray-700 whitespace-pre-line"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Session Q&A History -->
                    <div id="answers-history" style="display: none;">
                        <div class="card mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-2xl font-bold">üìã Session Q&A History</h3>
                                <div class="flex gap-3">
                                    <button onclick="downloadAnswerSessionPDF()" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-bold hover:shadow-glow">üì• Download All (PDF)</button>
                                    <button onclick="clearAnswerHistory()" class="px-6 py-2 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg font-bold hover:shadow-glow">üóëÔ∏è Clear</button>
                                </div>
                            </div>
                            <div id="history-content" class="space-y-6"></div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="answers-empty-state">
                        <div class="card text-center py-12">
                            <p class="text-6xl mb-4">üìÅ</p>
                            <p class="text-gray-600 mb-4 text-lg">No topics available</p>
                            <p class="text-sm text-gray-500 mb-6">Upload your syllabus and past papers to generate exam-ready answers</p>
                            <button onclick="goToPage('upload')" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold hover:shadow-glow">Upload Files Now</button>
                        </div>
                    </div>
                </div>

                <!-- Study Planner Page -->
                <div id="planner" class="page p-6 animate-fade-in max-w-7xl mx-auto">
                    <h1 class="text-3xl font-bold mb-2">üìÖ Personalized Study Schedule</h1>
                    <p id="planner-days-left" class="text-gray-600 mb-6">Plan your sessions per subject</p>

                    <!-- Subject Selector -->
                    <div class="card mb-6">
                        <h3 class="text-lg font-bold mb-3">üéØ Select Subject</h3>
                        <select id="planner-subject-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            <option value="">Select a subject</option>
                        </select>
                    </div>

                    <!-- Dynamic Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="card"><p class="text-sm text-gray-600">Total Hours</p><p id="planner-total-hours" class="text-2xl font-bold text-purple-600">0h</p></div>
                        <div class="card"><p class="text-sm text-gray-600">Progress</p><p id="planner-progress" class="text-2xl font-bold text-green-600">0%</p></div>
                        <div class="card"><p class="text-sm text-gray-600">Topics Left</p><p id="planner-topics-left" class="text-2xl font-bold text-orange-600">0</p></div>
                        <div class="card"><p class="text-sm text-gray-600">Expected Score</p><p id="planner-expected-score" class="text-2xl font-bold text-blue-600">--</p></div>
                    </div>

                    <!-- Schedule Builder -->
                    <div class="card mb-6">
                        <h3 class="text-lg font-bold mb-4">üìã Build Your Daily Schedule</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-sm font-bold mb-2 block">Date</label>
                                <input type="date" id="planner-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-sm font-bold mb-2 block">Start Time</label>
                                    <input type="time" id="planner-start" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="text-sm font-bold mb-2 block">End Time</label>
                                    <input type="time" id="planner-end" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-bold mb-2 block">Session Type</label>
                                <select id="planner-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                    <option>Theory</option>
                                    <option>Practice</option>
                                    <option>Revision</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-bold mb-2 block">Topic / Notes</label>
                                <input type="text" id="planner-topic" placeholder="e.g., Integrals - substitution method" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <button onclick="addPlannerSession()" class="w-full px-6 py-3 gradient-primary text-white rounded-lg font-bold hover:shadow-glow">Add Session</button>
                    </div>

                    <!-- Sessions List -->
                    <div class="card mb-6">
                        <h3 class="text-lg font-bold mb-3">üìÖ Your Sessions</h3>
                        <div id="planner-sessions" class="space-y-2">
                            <p class="text-sm text-gray-500">No sessions yet. Add your first session above.</p>
                        </div>
                    </div>

                    <!-- Day Schedule / Weekly Timetable -->
                    <div class="card mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold">üóìÔ∏è Day Schedule</h3>
                            <span id="timetable-week-range" class="text-xs text-gray-500"></span>
                        </div>
                        <div class="timetable-grid">
                            <div class="timetable-day day-mon">Monday</div>
                            <div class="timetable-day day-tue">Tuesday</div>
                            <div class="timetable-day day-wed">Wednesday</div>
                            <div class="timetable-day day-thu">Thursday</div>
                            <div class="timetable-day day-fri">Friday</div>
                            <div class="timetable-day day-sat">Saturday</div>
                            <div class="timetable-day day-sun">Sunday</div>

                            <div id="tt-mon" class="timetable-cell"></div>
                            <div id="tt-tue" class="timetable-cell"></div>
                            <div id="tt-wed" class="timetable-cell"></div>
                            <div id="tt-thu" class="timetable-cell"></div>
                            <div id="tt-fri" class="timetable-cell"></div>
                            <div id="tt-sat" class="timetable-cell"></div>
                            <div id="tt-sun" class="timetable-cell"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="downloadPlanPDF()" class="card text-center hover:shadow-glow">
                            <p style="font-size: 48px;">üì•</p>
                            <p class="font-bold">Download Plan (PDF)</p>
                        </button>
                        <button onclick="toggleNotifications()" class="card text-center hover:shadow-glow">
                            <p style="font-size: 48px;">üîî</p>
                            <p class="font-bold">Enable Notifications</p>
                        </button>
                    </div>
                </div>

                <!-- Upload Page -->
                <div id="upload" class="page p-6 animate-fade-in max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold mb-2">üì§ Upload Study Materials</h1>
                    <p class="text-gray-600 mb-8">Add your subjects and upload past papers, syllabus, and notes for AI analysis</p>

                    <!-- Add Subject Section -->
                    <div class="card mb-6">
                        <h2 class="text-xl font-bold mb-4">‚ûï Add New Subject</h2>
                        <div class="flex gap-3">
                            <input type="text" id="new-subject-input" placeholder="Enter subject name (e.g., Mathematics, Physics)" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg">
                            <button onclick="addSubject()" class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold hover:shadow-glow">Add Subject</button>
                        </div>
                    </div>

                    <!-- Your Subjects -->
                    <div class="card mb-6">
                        <h2 class="text-xl font-bold mb-4">üìö Your Subjects</h2>
                        <div id="subjects-list" class="space-y-2">
                            <p class="text-gray-500 text-sm">No subjects added yet. Add your first subject above!</p>
                        </div>
                    </div>

                    <!-- Upload Files Section -->
                    <div class="card space-y-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">üìÅ Upload Files</h2>
                        
                        <div>
                            <label class="block text-sm font-bold mb-2">Select Subject</label>
                            <select id="upload-subject-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="">Select a subject first</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-bold mb-2">üìÑ Upload Syllabus</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-purple-500 transition-colors">
                                <input type="file" id="syllabus-upload" class="hidden" accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(this, 'syllabus')">
                                <label for="syllabus-upload" class="cursor-pointer">
                                    <p class="text-3xl mb-2">üìÑ</p>
                                    <p class="font-semibold mb-1">Click to upload syllabus</p>
                                    <p class="text-sm text-gray-500">PDF, DOC, or TXT file</p>
                                </label>
                                <div id="syllabus-status" class="mt-2 text-sm"></div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold mb-2">üìö Upload Past Papers</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-purple-500 transition-colors">
                                <input type="file" id="papers-upload" class="hidden" accept=".pdf,.doc,.docx,.jpg,.png" multiple onchange="handleFileUpload(this, 'papers')">
                                <label for="papers-upload" class="cursor-pointer">
                                    <p class="text-3xl mb-2">üìö</p>
                                    <p class="font-semibold mb-1">Click to upload past papers</p>
                                    <p class="text-sm text-gray-500">Multiple files supported (PDF, DOC, Images)</p>
                                </label>
                                <div id="papers-status" class="mt-2 text-sm"></div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold mb-2">üìù Upload Notes (Optional)</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-purple-500 transition-colors">
                                <input type="file" id="notes-upload" class="hidden" accept=".pdf,.doc,.docx,.txt" multiple onchange="handleFileUpload(this, 'notes')">
                                <label for="notes-upload" class="cursor-pointer">
                                    <p class="text-3xl mb-2">üìù</p>
                                    <p class="font-semibold mb-1">Click to upload your notes</p>
                                    <p class="text-sm text-gray-500">Your study materials</p>
                                </label>
                                <div id="notes-status" class="mt-2 text-sm"></div>
                            </div>
                        </div>

                        <button onclick="processUploads()" class="w-full px-6 py-3 gradient-primary text-white rounded-lg font-bold hover:shadow-glow">Process & Analyze Files</button>
                    </div>

                    <!-- Uploaded Files Summary - At Bottom -->
                    <div id="uploaded-files-summary" class="card" style="display: none;">
                        <div class="mb-6">
                            <h2 class="text-lg font-bold flex items-center">‚úÖ Your Uploaded Files</h2>
                        </div>
                        <div id="files-summary-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">‚öôÔ∏è Settings</h2>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div class="space-y-6">
                <!-- API Key Configuration -->
                <div class="pb-4 border-b border-gray-200">
                    <h3 class="font-semibold text-gray-900 mb-3">üîë OpenAI API Configuration</h3>
                    <p class="text-sm text-gray-600 mb-4">Enter your OpenAI API key (starts with sk-) to enable AI-powered document analysis</p>
                    <div class="space-y-3">
                        <input type="password" id="openai-api-key" placeholder="sk-..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                        <div class="flex gap-3">
                            <button onclick="saveApiKey()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-semibold hover:shadow-lg">üíæ Save Key</button>
                            <button onclick="testApiKey()" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg font-semibold hover:shadow-lg">üß™ Test</button>
                            <button onclick="clearApiKey()" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600">üóëÔ∏è</button>
                        </div>
                        <div id="api-status" class="text-sm"></div>
                    </div>
                </div>

                <!-- Dark Mode -->
                <div class="flex items-center justify-between pb-4 border-b border-gray-200">
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-1">üåô Dark Mode</h3>
                        <p class="text-sm text-gray-600">Toggle dark theme</p>
                    </div>
                    <div class="toggle-switch" id="dark-mode-toggle" onclick="toggleDarkMode()"></div>
                </div>

                <!-- Notifications -->
                <div class="flex items-center justify-between pb-4 border-b border-gray-200">
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-1">üîî Notifications</h3>
                        <p class="text-sm text-gray-600">Enable study reminders</p>
                    </div>
                    <div class="toggle-switch" id="notification-toggle" onclick="toggleNotifications()"></div>
                </div>

                <!-- Profile Settings -->
                <button onclick="openProfileSettings()" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üë§</span>
                        <div class="text-left">
                            <h3 class="font-semibold text-gray-900">Profile Settings</h3>
                            <p class="text-sm text-gray-600">Edit your personal information</p>
                        </div>
                    </div>
                    <span class="text-gray-400">‚Üí</span>
                </button>

                <!-- Language -->
                <div class="pb-4 border-b border-gray-200">
                    <h3 class="font-semibold text-gray-900 mb-3">üåç Language</h3>
                    <select id="language-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="en">English</option>
                        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                    </select>
                </div>

                <!-- Data & Storage -->
                <button onclick="clearCache()" class="w-full flex items-center justify-between p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üíæ</span>
                        <div class="text-left">
                            <h3 class="font-semibold text-gray-900">Clear Cache</h3>
                            <p class="text-sm text-gray-600">Free up storage space</p>
                        </div>
                    </div>
                    <span class="text-gray-400">‚Üí</span>
                </button>

                <!-- Export Data -->
                <button onclick="exportData()" class="w-full flex items-center justify-between p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üì•</span>
                        <div class="text-left">
                            <h3 class="font-semibold text-gray-900">Export Data</h3>
                            <p class="text-sm text-gray-600">Download your study data</p>
                        </div>
                    </div>
                    <span class="text-gray-400">‚Üí</span>
                </button>

                <!-- Privacy Policy -->
                <button onclick="showPrivacyPolicy()" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üîí</span>
                        <div class="text-left">
                            <h3 class="font-semibold text-gray-900">Privacy Policy</h3>
                            <p class="text-sm text-gray-600">View our privacy terms</p>
                        </div>
                    </div>
                    <span class="text-gray-400">‚Üí</span>
                </button>

                <!-- About -->
                <button onclick="showAbout()" class="w-full flex items-center justify-between p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">‚ÑπÔ∏è</span>
                        <div class="text-left">
                            <h3 class="font-semibold text-gray-900">About</h3>
                            <p class="text-sm text-gray-600">Version 1.0.0</p>
                        </div>
                    </div>
                    <span class="text-gray-400">‚Üí</span>
                </button>

                <!-- Logout -->
                <button onclick="handleLogout()" class="w-full flex items-center justify-center space-x-2 p-4 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-lg transition-colors font-semibold">
                    <span class="text-xl">üö™</span>
                    <span>Logout</span>
                </button>

                <!-- Delete Account -->
                <button onclick="confirmDeleteAccount()" class="w-full flex items-center justify-center space-x-2 p-4 bg-red-50 hover:bg-red-100 text-red-700 rounded-lg transition-colors font-semibold">
                    <span class="text-xl">üóëÔ∏è</span>
                    <span>Delete Account</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">üë§ Profile Settings</h2>
                <button onclick="closeProfileSettings()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Full Name</label>
                    <input type="text" id="profile-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Email</label>
                    <input type="email" id="profile-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Username</label>
                    <input type="text" id="profile-username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Primary Subject</label>
                    <select id="profile-subject" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="Mathematics">Mathematics</option>
                        <option value="Physics">Physics</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="Biology">Biology</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Commerce">Commerce</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button onclick="saveProfile()" class="flex-1 gradient-primary text-white py-3 rounded-lg font-bold hover:shadow-glow">Save Changes</button>
                    <button onclick="closeProfileSettings()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-300">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Syllabus Preview Modal -->
    <div id="syllabus-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">üìÑ Syllabus Overview</h2>
                <button onclick="closeSyllabusModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div id="syllabus-preview-content" class="space-y-4">
                <!-- Dynamic content -->
            </div>

            <div class="flex space-x-3 pt-4">
                <button onclick="goToPage('planner'); closeSyllabusModal();" class="flex-1 gradient-primary text-white py-3 rounded-lg font-bold hover:shadow-glow">View in Detail (Study Schedule)</button>
                <button onclick="closeSyllabusModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Marks Editor Modal -->
    <div id="marks-editor-modal" class="modal">
        <div class="modal-content max-w-md">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">‚≠ê Edit Custom Marks</h2>
                <button onclick="closeMarksEditor()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div class="space-y-4">
                <p class="text-sm text-gray-600">Enter the mark values you want separated by commas (e.g., 5, 10, 15, 20)</p>
                <textarea id="marks-input" placeholder="5, 10, 15" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                <div id="marks-preview" class="space-y-2"></div>
            </div>

            <div class="flex space-x-3 pt-6">
                <button onclick="saveCustomMarks()" class="flex-1 gradient-primary text-white py-3 rounded-lg font-bold hover:shadow-glow">Save Marks</button>
                <button onclick="closeMarksEditor()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Bharat Academic Copilot - Script Loaded');
        
        // ==================== OPENAI API KEY ====================
        // No hardcoded key. Use Settings to provide your own key at runtime.
        const HARDCODED_API_KEY = "";
        
        // Function to get API key (hardcoded fallback)
        function getApiKey() {
            // First check Settings (if user wants to override)
            const settingsKey = localStorage.getItem('openai_api_key');
            if (settingsKey && settingsKey.startsWith('sk-')) {
                return settingsKey;
            }
            // Fallback to hardcoded key
            if (HARDCODED_API_KEY && HARDCODED_API_KEY.startsWith('sk-')) {
                return HARDCODED_API_KEY;
            }
            return null;
        }
        
        // ==================== CUSTOM NOTIFICATIONS ====================
        
        function showNotification(icon, title, message, type = 'success') {
            const popup = document.getElementById('notification-popup');
            const overlay = document.getElementById('notification-overlay');
            const iconEl = document.getElementById('notification-icon');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');
            
            iconEl.textContent = icon;
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Apply color based on type
            if (type === 'error') {
                titleEl.className = 'text-2xl font-bold mb-2 text-red-600';
            } else if (type === 'warning') {
                titleEl.className = 'text-2xl font-bold mb-2 text-orange-600';
            } else if (type === 'info') {
                titleEl.className = 'text-2xl font-bold mb-2 text-blue-600';
            } else {
                titleEl.className = 'text-2xl font-bold mb-2 text-green-600';
            }
            
            overlay.classList.add('show');
            popup.classList.add('show');
        }
        
        function closeNotification() {
            const popup = document.getElementById('notification-popup');
            const overlay = document.getElementById('notification-overlay');
            popup.classList.remove('show');
            overlay.classList.remove('show');
        }

        // ==================== AUTHENTICATION ====================
        
        // Check if user is logged in on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Close notification on overlay click
            document.getElementById('notification-overlay').addEventListener('click', closeNotification);
            
            // Check if user is logged in
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                const userData = JSON.parse(currentUser);
                showMainApp(userData);
            } else {
                document.getElementById('auth-page').style.display = 'flex';
            }

            // Load dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                                document.documentElement.classList.add('dark');
                document.getElementById('dark-mode-toggle').classList.add('active');
            }

            // Load notification preference
            if (localStorage.getItem('notifications') === 'true') {
                document.getElementById('notification-toggle').classList.add('active');
            }
        });

        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
        }

        function showSignup() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
        }

        // ==================== USER UTILITY FUNCTIONS ====================

        function getCurrentUser() {
            const currentUserData = localStorage.getItem('currentUser');
            if (!currentUserData) return null;
            
            const user = JSON.parse(currentUserData);
            // Get full user data from users array
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const fullUser = users.find(u => u.email === user.email);
            return fullUser || user;
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showNotification('‚ö†Ô∏è', 'Missing Information', 'Please enter both email/username and password', 'warning');
                return;
            }

            // Get users from localStorage
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => 
                (u.email === email || u.username === email) && u.password === password
            );

            if (user) {
                // Successful login - load ALL user data
                const userData = {
                    name: user.name,
                    email: user.email,
                    username: user.username,
                    password: user.password,
                    examDate: user.examDate,
                    subjects: user.subjects || [],
                    uploads: user.uploads || {},
                    aiAnalysis: user.aiAnalysis || {},
                    answerSessions: user.answerSessions || {},
                    studyPlans: user.studyPlans || {},
                    customAnswerMarks: user.customAnswerMarks || []
                };
                localStorage.setItem('currentUser', JSON.stringify(userData));
                showNotification('üéâ', 'Welcome Back!', `Successfully logged in as ${userData.name}`, 'success');
                setTimeout(() => {
                    closeNotification();
                    showMainApp(userData);
                }, 1500);
            } else {
                showNotification('‚ùå', 'Login Failed', 'Invalid credentials. Please check your email/username and password.', 'error');
            }
        }

        function handleSignup() {
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value;
            const examDate = document.getElementById('signup-exam-date').value;
            const termsAccepted = document.getElementById('signup-terms').checked;

            // Validation with specific messages
            if (!name) {
                showNotification('‚ö†Ô∏è', 'Name Required', 'Please enter your full name', 'warning');
                return;
            }

            if (!email) {
                showNotification('‚ö†Ô∏è', 'Email Required', 'Please enter your email address', 'warning');
                return;
            }

            if (!username) {
                showNotification('‚ö†Ô∏è', 'Username Required', 'Please choose a username', 'warning');
                return;
            }

            if (!password) {
                showNotification('‚ö†Ô∏è', 'Password Required', 'Please create a password', 'warning');
                return;
            }

            if (password.length < 6) {
                showNotification('‚ö†Ô∏è', 'Password Too Short', 'Password must be at least 6 characters', 'warning');
                return;
            }

            if (!examDate) {
                showNotification('‚ö†Ô∏è', 'Exam Date Required', 'Please select your exam date', 'warning');
                return;
            }

            if (!termsAccepted) {
                showNotification('‚ö†Ô∏è', 'Terms Required', 'Please accept the Terms of Service to continue', 'warning');
                return;
            }

            // Check if user already exists
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const existingUser = users.find(u => u.email === email || u.username === username);

            if (existingUser) {
                showNotification('‚ùå', 'Account Exists', 'Email or username already exists. Please login instead.', 'error');
                return;
            }

            // Create new user
            const newUser = { 
                name, 
                email, 
                username, 
                password, 
                examDate, 
                subjects: [], 
                uploads: {},
                aiAnalysis: {},
                answerSessions: {},
                studyPlans: {},
                customAnswerMarks: [],
                createdAt: new Date().toISOString() 
            };
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));

            // Auto login with complete user data
            const userData = { 
                name, 
                email, 
                username, 
                password,
                examDate, 
                subjects: [],
                uploads: {},
                aiAnalysis: {},
                answerSessions: {},
                studyPlans: {},
                customAnswerMarks: []
            };
            localStorage.setItem('currentUser', JSON.stringify(userData));
            
            showNotification('üéâ', 'Account Created!', `Welcome ${name}! Your account has been created successfully.`, 'success');
            setTimeout(() => {
                closeNotification();
                showMainApp(userData);
            }, 2000);
        }

        function showMainApp(userData) {
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';

            // Update UI with user data
            const firstLetter = userData.name.charAt(0).toUpperCase();
            document.getElementById('user-display-name').textContent = userData.name;
            const subjectDisplay = userData.subjects && userData.subjects.length > 0 ? userData.subjects[0] : 'No subjects yet';
            document.getElementById('user-subject').textContent = subjectDisplay;
            document.getElementById('user-avatar').textContent = firstLetter;

            // Update profile dropdown
            document.getElementById('dropdown-avatar').textContent = firstLetter;
            document.getElementById('dropdown-name').textContent = userData.name;
            document.getElementById('dropdown-username').textContent = '@' + userData.username;
            const subjectsText = userData.subjects && userData.subjects.length > 0 ? userData.subjects.join(', ') : 'No subjects yet';
            document.getElementById('dropdown-subject').textContent = subjectsText;

            // Calculate and display days left
            if (userData.examDate) {
                const today = new Date();
                const examDate = new Date(userData.examDate);
                const diffTime = examDate - today;
                const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                const daysText = document.getElementById('days-left-text');
                const daysBadge = document.getElementById('days-left-badge');
                
                if (daysLeft > 0) {
                    daysText.textContent = `${daysLeft} days left`;
                    
                    // Change color based on days left
                    if (daysLeft <= 7) {
                        daysBadge.className = 'hidden sm:flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-red-50 to-orange-50 rounded-lg border border-red-200';
                        daysText.className = 'text-xs font-semibold text-red-700';
                    } else if (daysLeft <= 15) {
                        daysBadge.className = 'hidden sm:flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200';
                        daysText.className = 'text-xs font-semibold text-orange-700';
                    } else {
                        daysBadge.className = 'hidden sm:flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200';
                        daysText.className = 'text-xs font-semibold text-green-700';
                    }
                } else if (daysLeft === 0) {
                    daysText.textContent = 'Exam Today! üéØ';
                    daysBadge.className = 'hidden sm:flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200';
                    daysText.className = 'text-xs font-semibold text-purple-700';
                } else {
                    daysText.textContent = 'Exam Passed';
                    daysBadge.className = 'hidden sm:flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-gray-50 to-slate-50 rounded-lg border border-gray-200';
                    daysText.className = 'text-xs font-semibold text-gray-700';
                }
            }

            // Update dashboard greeting
            const dashboardGreeting = document.querySelector('#dashboard h1');
            if (dashboardGreeting) {
                dashboardGreeting.textContent = `Hey, ${userData.name.split(' ')[0]}! üëã`;
            }

            // Update dashboard subject reference
            const dashboardSubject = document.querySelector('#dashboard .gradient-primary.rounded-2xl p');
            if (dashboardSubject && userData.examDate) {
                const today = new Date();
                const examDate = new Date(userData.examDate);
                const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
                const subjectCount = userData.subjects && userData.subjects.length;
                if (daysLeft > 0) {
                    if (subjectCount > 0) {
                        dashboardSubject.textContent = `Let's conquer your ${subjectCount} subject${subjectCount > 1 ? 's' : ''} exam in ${daysLeft} days`;
                    } else {
                        dashboardSubject.textContent = `Upload your subjects and past papers to get started!`;
                    }
                }
            }

            // Update subject display in header
            const userSubjectEl = document.getElementById('user-subject');
            if (userSubjectEl) {
                if (userData.subjects && userData.subjects.length > 0) {
                    userSubjectEl.textContent = `${userData.subjects.length} Subject${userData.subjects.length > 1 ? 's' : ''}`;
                } else {
                    userSubjectEl.textContent = 'Add subjects';
                }
            }
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            closeSettings();
            showNotification('üëã', 'Logged Out', 'You have been logged out successfully', 'success');
            
            setTimeout(() => {
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('auth-page').style.display = 'flex';
                
                // Reset forms
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                closeNotification();
                showLogin();
            }, 1500);
        }

        // ==================== PROFILE DROPDOWN ====================
        
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('profile-dropdown');
            const profileButton = dropdown?.previousElementSibling;
            if (dropdown && !dropdown.contains(e.target) && !profileButton?.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // ==================== MOTIVATIONAL NOTIFICATIONS ====================
        
        const motivationalMessages = [
            { icon: 'üöÄ', title: 'You Got This!', message: 'Every hour of study brings you closer to success!' },
            { icon: 'üí™', title: 'Stay Strong!', message: 'Champions are made through hard work and dedication!' },
            { icon: '‚≠ê', title: 'Believe in Yourself!', message: 'Your potential is limitless. Keep pushing forward!' },
            { icon: 'üéØ', title: 'Focus Mode!', message: 'One topic at a time. You\'re making great progress!' },
            { icon: '‚ú®', title: 'Shine Bright!', message: 'Your future is being created by what you do today!' },
            { icon: 'üî•', title: 'On Fire!', message: 'Your dedication is inspiring. Keep up the momentum!' },
            { icon: 'üåü', title: 'Star Student!', message: 'Excellence is a habit. You\'re building it every day!' },
            { icon: 'üíé', title: 'Precious Progress!', message: 'Small steps lead to big achievements. Keep going!' },
            { icon: 'üéì', title: 'Scholar in Making!', message: 'Knowledge is power, and you\'re getting stronger!' },
            { icon: 'üèÜ', title: 'Champion Mindset!', message: 'Success isn\'t just about grades, it\'s about growth!' },
            { icon: 'üåà', title: 'Bright Future!', message: 'After every study session, you\'re one step closer to your dreams!' },
            { icon: '‚ö°', title: 'Power Learning!', message: 'Your brain is amazing! Feed it with knowledge!' },
            { icon: 'üé™', title: 'Balance Matters!', message: 'Remember to take breaks. A fresh mind learns better!' },
            { icon: 'üß†', title: 'Brain Boost!', message: 'You\'re training your mind to achieve greatness!' },
            { icon: 'üå∫', title: 'Bloom & Grow!', message: 'Like a flower, your knowledge is blossoming beautifully!' }
        ];

        let lastMotivationIndex = -1;

        function showMotivation() {
            // Get a different message each time
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * motivationalMessages.length);
            } while (randomIndex === lastMotivationIndex && motivationalMessages.length > 1);
            
            lastMotivationIndex = randomIndex;
            const msg = motivationalMessages[randomIndex];
            showNotification(msg.icon, msg.title, msg.message, 'info');
        }

        // ==================== SUBJECT MANAGEMENT ====================
        
        function addSubject() {
            const input = document.getElementById('new-subject-input');
            const subjectName = input.value.trim();
            
            if (!subjectName) {
                showNotification('‚ö†Ô∏è', 'Subject Name Required', 'Please enter a subject name', 'warning');
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser.subjects) currentUser.subjects = [];
            
            // Check if subject already exists
            if (currentUser.subjects.includes(subjectName)) {
                showNotification('‚ö†Ô∏è', 'Subject Exists', 'This subject is already added', 'warning');
                return;
            }
            
            // Add subject
            currentUser.subjects.push(subjectName);
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Update in users array
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                users[userIndex].subjects = currentUser.subjects;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            input.value = '';
            showNotification('‚úÖ', 'Subject Added!', `${subjectName} has been added to your subjects`, 'success');
            updateSubjectsList();
            updateUploadSubjectDropdown();
        }
        
        function updateSubjectsList() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const container = document.getElementById('subjects-list');
            
            if (!currentUser.subjects || currentUser.subjects.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No subjects added yet. Add your first subject above!</p>';
                return;
            }
            
            container.innerHTML = currentUser.subjects.map((subject, index) => `
                <div class="flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                    <span class="font-semibold text-gray-900">üìö ${subject}</span>
                    <button onclick="removeSubject(${index})" class="text-red-600 hover:text-red-700 font-bold">‚úï</button>
                </div>
            `).join('');
        }
        
        function removeSubject(index) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const subjectName = currentUser.subjects[index];
            
            if (confirm(`Remove ${subjectName}? This will also remove all uploaded files for this subject.`)) {
                currentUser.subjects.splice(index, 1);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Update in users array
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex].subjects = currentUser.subjects;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                showNotification('‚úÖ', 'Subject Removed', `${subjectName} has been removed`, 'info');
                updateSubjectsList();
                updateUploadSubjectDropdown();
            }
        }
        
        function updateUploadSubjectDropdown() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const select = document.getElementById('upload-subject-select');
            
            if (!select) return;
            
            if (!currentUser.subjects || currentUser.subjects.length === 0) {
                select.innerHTML = '<option value="">Add a subject first</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Select a subject</option>' + 
                currentUser.subjects.map(subject => 
                    `<option value="${subject}">${subject}</option>`
                ).join('');
        }
        
        // ==================== AI DOCUMENT PROCESSING ====================

        // Extract text from PDF using PDF.js
        async function extractTextFromPDF(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';
                    
                    for (let i = 1; i <= Math.min(pdf.numPages, 20); i++) { // Limit to first 20 pages
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }
                    
                    resolve(fullText);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Extract text from Word document using Mammoth
        async function extractTextFromWord(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    resolve(result.value);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Extract text from any supported file
        async function extractTextFromFile(file) {
            const fileType = file.type;
            const fileName = file.name.toLowerCase();

            try {
                if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
                    return await extractTextFromPDF(file);
                } else if (fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || fileName.endsWith('.docx')) {
                    return await extractTextFromWord(file);
                } else if (fileType === 'text/plain' || fileName.endsWith('.txt')) {
                    return await file.text();
                } else {
                    return `[Unsupported file type: ${fileType}]`;
                }
            } catch (error) {
                console.error('Error extracting text:', error);
                return `[Error reading file: ${error.message}]`;
            }
        }

        // Analyze document with OpenAI GPT-4
        async function analyzeDocumentWithAI(text, subject, documentType) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('No API key configured. Please add your OpenAI key at the top of the code.');
            }

            const prompt = `You are an expert academic analyzer. Analyze this ${documentType} document for ${subject} and extract:

1. **Core Topics**: List all main topics covered (10-15 topics)
2. **Important Topics**: Identify which topics are most critical for exams (based on depth and emphasis)
3. **Subtopics**: Break down main topics into subtopics
4. **Topic Importance**: Rate each topic as High, Medium, or Low priority for exam preparation

Document content:
${text.substring(0, 15000)}

Return your analysis in this JSON format:
{
  "coreTopics": ["topic1", "topic2", ...],
  "importantTopics": ["topic1", "topic2", ...],
  "subtopics": {
    "mainTopic1": ["subtopic1", "subtopic2"],
    "mainTopic2": ["subtopic1", "subtopic2"]
  },
  "priorityLevels": {
    "topic1": "High",
    "topic2": "Medium",
    "topic3": "Low"
  }
}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: 'You are an expert academic content analyzer. Always return valid JSON only.' },
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.3,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`OpenAI API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                const content = data.choices?.[0]?.message?.content;
                
                if (!content) {
                    throw new Error('No response from OpenAI API');
                }
                
                // Extract JSON from response (in case it's wrapped in markdown code blocks)
                let jsonMatch = content.match(/```json\n([\s\S]*?)\n```/) || content.match(/```\n([\s\S]*?)\n```/);
                const jsonText = jsonMatch ? jsonMatch[1] : content;
                
                return JSON.parse(jsonText);
            } catch (error) {
                console.error('OpenAI API error:', error);
                throw error;
            }
        }

        // Process all uploaded files for a subject with AI
        async function processFilesWithAI(subject) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const uploads = currentUser.uploads?.[subject];
            
            if (!uploads) return null;

            let allAnalysis = {
                coreTopics: [],
                importantTopics: [],
                subtopics: {},
                priorityLevels: {}
            };

            // Process each file type
            for (const [type, files] of Object.entries(uploads)) {
                if (!files || files.length === 0) continue;

                for (const fileInfo of files) {
                    // Note: We don't have the actual file object here, only metadata
                    // In a real scenario, you'd re-read the file or store it
                    // For now, we'll skip actual processing and use the stored analysis if available
                }
            }

            return allAnalysis;
        }
        
        // File upload handlers
        async function handleFileUpload(input, type) {
            const subject = document.getElementById('upload-subject-select').value;
            
            if (!subject) {
                showNotification('‚ö†Ô∏è', 'Select Subject', 'Please select a subject first before uploading files', 'warning');
                input.value = '';
                return;
            }
            
            const files = input.files;
            if (files.length === 0) return;
            
            const statusEl = document.getElementById(`${type}-status`);
            const fileNames = Array.from(files).map(f => f.name).join(', ');
            
            statusEl.innerHTML = `<span class="text-blue-600">üîÑ Processing ${files.length} file(s)...</span>`;
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser.uploads) currentUser.uploads = {};
            if (!currentUser.uploads[subject]) currentUser.uploads[subject] = {};
            
            // Store file metadata and extracted text
            const fileDataArray = [];
            
            for (const file of files) {
                try {
                    // Extract text from file
                    const extractedText = await extractTextFromFile(file);
                    
                    // Analyze with AI if API key is configured
                    let aiAnalysis = null;
                    const apiKey = getApiKey();
                    if (apiKey && extractedText && extractedText.length > 100) {
                        try {
                            statusEl.innerHTML = `<span class="text-purple-600">ü§ñ AI analyzing ${file.name}...</span>`;
                            aiAnalysis = await analyzeDocumentWithAI(extractedText, subject, type);
                        } catch (error) {
                            console.error('AI analysis failed:', error);
                            showNotification('‚ö†Ô∏è', 'AI Analysis Failed', `Stored file but AI analysis failed: ${error.message}`, 'warning');
                        }
                    }
                    
                    fileDataArray.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadedAt: new Date().toISOString(),
                        extractedText: extractedText.substring(0, 5000), // Store first 5000 chars
                        aiAnalysis: aiAnalysis
                    });
                } catch (error) {
                    console.error('File processing error:', error);
                    fileDataArray.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadedAt: new Date().toISOString(),
                        error: error.message
                    });
                }
            }
            
            currentUser.uploads[subject][type] = fileDataArray;
            
            // Merge AI analysis across all files
            if (!currentUser.aiAnalysis) currentUser.aiAnalysis = {};
            if (!currentUser.aiAnalysis[subject]) {
                currentUser.aiAnalysis[subject] = {
                    coreTopics: [],
                    importantTopics: [],
                    subtopics: {},
                    priorityLevels: {}
                };
            }
            
            // Merge analyses from all files
            fileDataArray.forEach(fileData => {
                if (fileData.aiAnalysis) {
                    const analysis = fileData.aiAnalysis;
                    
                    // Merge core topics (deduplicate)
                    if (analysis.coreTopics) {
                        analysis.coreTopics.forEach(topic => {
                            if (!currentUser.aiAnalysis[subject].coreTopics.includes(topic)) {
                                currentUser.aiAnalysis[subject].coreTopics.push(topic);
                            }
                        });
                    }
                    
                    // Merge important topics
                    if (analysis.importantTopics) {
                        analysis.importantTopics.forEach(topic => {
                            if (!currentUser.aiAnalysis[subject].importantTopics.includes(topic)) {
                                currentUser.aiAnalysis[subject].importantTopics.push(topic);
                            }
                        });
                    }
                    
                    // Merge subtopics and priority levels
                    if (analysis.subtopics) {
                        Object.assign(currentUser.aiAnalysis[subject].subtopics, analysis.subtopics);
                    }
                    if (analysis.priorityLevels) {
                        Object.assign(currentUser.aiAnalysis[subject].priorityLevels, analysis.priorityLevels);
                    }
                }
            });
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // CRITICAL: Sync to users array to persist across login/logout
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                users[userIndex].uploads = currentUser.uploads;
                users[userIndex].aiAnalysis = currentUser.aiAnalysis;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            const aiUsed = fileDataArray.some(f => f.aiAnalysis);
            if (aiUsed) {
                statusEl.innerHTML = `<span class="text-green-600">‚úì ${files.length} file(s) processed with AI: ${fileNames}</span>`;
                showNotification('ü§ñ', 'AI Analysis Complete!', `${files.length} file(s) analyzed and topics extracted`, 'success');
            } else {
                statusEl.innerHTML = `<span class="text-green-600">‚úì ${files.length} file(s) uploaded: ${fileNames}</span>`;
            }
        }
        
        function processUploads() {
            const subject = document.getElementById('upload-subject-select').value;
            
            if (!subject) {
                showNotification('‚ö†Ô∏è', 'Select Subject', 'Please select a subject', 'warning');
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const uploads = currentUser.uploads?.[subject];
            
            if (!uploads || Object.keys(uploads).length === 0) {
                showNotification('‚ö†Ô∏è', 'No Files', 'Please upload at least one file before processing', 'warning');
                return;
            }
            
            // Check if at least one file type has files
            const hasFiles = (uploads.syllabus && uploads.syllabus.length > 0) ||
                           (uploads.papers && uploads.papers.length > 0) ||
                           (uploads.notes && uploads.notes.length > 0);
            
            if (!hasFiles) {
                showNotification('‚ö†Ô∏è', 'No Files Selected', 'Please upload at least one file', 'warning');
                return;
            }
            
            showNotification('üöÄ', 'Processing Files!', `Analyzing your ${subject} materials. This may take a moment...`, 'success');
            
            // Simulate processing
            setTimeout(() => {
                showNotification('‚úÖ', 'Analysis Complete!', `${subject} files processed successfully!`, 'success');
                
                // Display uploaded files summary for all subjects
                displayUploadedFilesSummary();
                
                // Reset form
                document.getElementById('syllabus-upload').value = '';
                document.getElementById('papers-upload').value = '';
                document.getElementById('notes-upload').value = '';
                document.getElementById('syllabus-status').innerHTML = '';
                document.getElementById('papers-status').innerHTML = '';
                document.getElementById('notes-status').innerHTML = '';
            }, 2000);
        }
        
        function initUploadPage() {
            // Display all uploaded files on page load
            displayUploadedFilesSummary();
        }

        function displayUploadedFilesSummary(subject) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const uploads = currentUser.uploads || {};
            
            // If we want to show all subjects, iterate through all
            const summaryDiv = document.getElementById('uploaded-files-summary');
            const contentDiv = document.getElementById('files-summary-content');
            contentDiv.innerHTML = '';
            
            let totalFiles = 0;
            
            // Create cards for each subject with files
            Object.entries(uploads).forEach(([subjectName, files]) => {
                const syllabusFiles = (files.syllabus || []);
                const papersFiles = (files.papers || []);
                const notesFiles = (files.notes || []);
                const total = syllabusFiles.length + papersFiles.length + notesFiles.length;
                
                if (total > 0) {
                    totalFiles += total;
                    const card = document.createElement('div');
                    card.className = 'border border-gray-300 rounded-lg p-4 bg-white hover:shadow-md transition-shadow';
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-sm text-purple-600">üìö ${subjectName}</h3>
                            <div class="flex gap-2">
                                <button onclick="toggleSubjectFiles('${subjectName}')" class="text-xs px-3 py-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded font-semibold hover:shadow-glow transition-all">üëÅÔ∏è Hide</button>
                                <button onclick="deleteSubjectFiles('${subjectName}')" class="text-xs px-3 py-1 bg-red-500 text-white rounded font-semibold hover:bg-red-600 transition-all">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <div class="space-y-2 text-xs mb-3">
                            ${syllabusFiles.length > 0 ? `<div class="flex items-center"><span class="inline-block w-5">üìÑ</span><span class="text-gray-700">${syllabusFiles.length} Syllabus</span></div>` : ''}
                            ${papersFiles.length > 0 ? `<div class="flex items-center"><span class="inline-block w-5">üìã</span><span class="text-gray-700">${papersFiles.length} Papers</span></div>` : ''}
                            ${notesFiles.length > 0 ? `<div class="flex items-center"><span class="inline-block w-5">üìù</span><span class="text-gray-700">${notesFiles.length} Notes</span></div>` : ''}
                        </div>
                        <div id="files-expand-${subjectName}" class="mt-3 pt-3 border-t border-gray-200 space-y-2 text-xs max-h-40 overflow-y-auto">
                            ${syllabusFiles.length > 0 ? `
                                <div class="font-semibold text-gray-600 mb-2">üìÑ Syllabus</div>
                                ${syllabusFiles.map((fileObj, i) => {
                                    const fileName = typeof fileObj === 'string' ? fileObj : fileObj.name;
                                    return `
                                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                            <span class="text-gray-700 truncate" title="${fileName}">${fileName}</span>
                                            <button onclick="downloadFile('${subjectName}', 'syllabus', ${i})" class="text-blue-500 hover:text-blue-700 font-semibold ml-2">‚¨áÔ∏è</button>
                                        </div>
                                    `;
                                }).join('')}
                            ` : ''}
                            ${papersFiles.length > 0 ? `
                                <div class="font-semibold text-gray-600 mb-2 mt-3">üìã Papers</div>
                                ${papersFiles.map((fileObj, i) => {
                                    const fileName = typeof fileObj === 'string' ? fileObj : fileObj.name;
                                    return `
                                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                            <span class="text-gray-700 truncate" title="${fileName}">${fileName}</span>
                                            <button onclick="downloadFile('${subjectName}', 'papers', ${i})" class="text-blue-500 hover:text-blue-700 font-semibold ml-2">‚¨áÔ∏è</button>
                                        </div>
                                    `;
                                }).join('')}
                            ` : ''}
                            ${notesFiles.length > 0 ? `
                                <div class="font-semibold text-gray-600 mb-2 mt-3">üìù Notes</div>
                                ${notesFiles.map((fileObj, i) => {
                                    const fileName = typeof fileObj === 'string' ? fileObj : fileObj.name;
                                    return `
                                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                            <span class="text-gray-700 truncate" title="${fileName}">${fileName}</span>
                                            <button onclick="downloadFile('${subjectName}', 'notes', ${i})" class="text-blue-500 hover:text-blue-700 font-semibold ml-2">‚¨áÔ∏è</button>
                                        </div>
                                    `;
                                }).join('')}
                            ` : ''}
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <span class="inline-block px-3 py-1 bg-gradient-to-r from-green-400 to-emerald-500 text-white rounded text-xs font-semibold">‚úì ${total} files</span>
                        </div>
                    `;
                    contentDiv.appendChild(card);
                }
            });
            
            if (totalFiles > 0) {
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        function toggleSubjectFiles(subjectName) {
            const expandDiv = document.getElementById(`files-expand-${subjectName}`);
            if (expandDiv) {
                expandDiv.classList.toggle('hidden');
                // Update button text
                const btn = event.target;
                if (expandDiv.classList.contains('hidden')) {
                    btn.textContent = 'üëÅÔ∏è View';
                } else {
                    btn.textContent = 'üëÅÔ∏è Hide';
                }
            }
        }

        function deleteSubjectFiles(subjectName) {
            const confirmDelete = confirm(`‚ö†Ô∏è Are you sure you want to delete all files for ${subjectName}?\n\nThis will remove:\n- All syllabus files\n- All past papers\n- All notes\n\nYou can upload them again later.`);
            
            if (confirmDelete) {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                
                if (currentUser.uploads && currentUser.uploads[subjectName]) {
                    // Delete all files for this subject
                    delete currentUser.uploads[subjectName];
                    
                    // Also delete any AI analysis for this subject
                    if (currentUser.aiAnalysis && currentUser.aiAnalysis[subjectName]) {
                        delete currentUser.aiAnalysis[subjectName];
                    }
                    
                    // Save updated data to currentUser
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // IMPORTANT: Also update in users array
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    const userIndex = users.findIndex(u => u.email === currentUser.email);
                    if (userIndex !== -1) {
                        users[userIndex].uploads = currentUser.uploads;
                        users[userIndex].aiAnalysis = currentUser.aiAnalysis;
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                    
                    // Refresh the display
                    displayUploadedFilesSummary();
                    
                    // Show success message
                    showNotification('üóëÔ∏è', 'Files Deleted', `All files for ${subjectName} have been removed. You can upload them again.`, 'success');
                    
                    // Update analysis page if visible
                    initAnalysis();
                }
            }
        }

        function downloadFile(subjectName, fileType, index) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const files = currentUser.uploads?.[subjectName]?.[fileType];
            
            if (files && files[index]) {
                const fileObj = files[index];
                const fileName = typeof fileObj === 'string' ? fileObj : fileObj.name;
                showNotification('üì•', 'Download', `Ready to download: ${fileName}`, 'info');
                // In a real app, this would trigger actual file download from server
            }
        }

        function toggleFilesSummary() {
            const contentDiv = document.getElementById('files-summary-content');
            if (contentDiv.style.display === 'none' || contentDiv.style.display === '') {
                contentDiv.style.display = 'grid';
            } else {
                contentDiv.style.display = 'none';
            }
        }
        
        // Update subjects list when upload page is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if on upload page and update
            const uploadPage = document.getElementById('upload');
            if (uploadPage) {
                const observer = new MutationObserver(function(mutations) {
                    if (uploadPage.classList.contains('active')) {
                        updateSubjectsList();
                        updateUploadSubjectDropdown();
                    }
                });
                observer.observe(uploadPage, { attributes: true, attributeFilter: ['class'] });
            }
        });

        // ==================== SETTINGS ====================

        function saveApiKey() {
            const apiKey = document.getElementById('openai-api-key').value.trim();
            if (!apiKey) {
                showNotification('‚ö†Ô∏è', 'No Key Entered', 'Please enter your OpenAI API key', 'warning');
                return;
            }
            if (!apiKey.startsWith('sk-')) {
                showNotification('‚ùå', 'Invalid Key', 'OpenAI API keys start with "sk-"', 'error');
                return;
            }
            localStorage.setItem('openai_api_key', apiKey);
            document.getElementById('api-status').innerHTML = '<p class="text-green-600 font-semibold">‚úÖ OpenAI API key saved successfully!</p>';
            showNotification('‚úÖ', 'API Key Saved', 'OpenAI integration is now active', 'success');
        }

        function clearApiKey() {
            localStorage.removeItem('openai_api_key');
            document.getElementById('openai-api-key').value = '';
            document.getElementById('api-status').innerHTML = '<p class="text-gray-600">üóëÔ∏è API key cleared</p>';
            showNotification('üóëÔ∏è', 'Key Cleared', 'OpenAI API key has been removed', 'info');
        }

        async function testApiKey() {
            const apiKey = getApiKey();
            if (!apiKey) {
                showNotification('‚ö†Ô∏è', 'No API Key', 'Please save your OpenAI API key first', 'warning');
                return;
            }

            document.getElementById('api-status').innerHTML = '<p class="text-blue-600">üîÑ Testing OpenAI connection...</p>';

            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (response.ok) {
                    document.getElementById('api-status').innerHTML = '<p class="text-green-600 font-semibold">‚úÖ Connection successful! OpenAI API is ready.</p>';
                    showNotification('‚úÖ', 'Connection Success', 'OpenAI API is working correctly', 'success');
                } else {
                    document.getElementById('api-status').innerHTML = '<p class="text-red-600 font-semibold">‚ùå Invalid API key or connection failed</p>';
                    showNotification('‚ùå', 'Connection Failed', 'Please check your OpenAI API key', 'error');
                }
            } catch (error) {
                document.getElementById('api-status').innerHTML = '<p class="text-red-600 font-semibold">‚ùå Network error: ' + error.message + '</p>';
                showNotification('‚ùå', 'Network Error', 'Could not connect to OpenAI', 'error');
            }
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            // Load saved API key from settings
            const settingsKey = localStorage.getItem('openai_api_key');
            const hardcodedActive = HARDCODED_API_KEY && HARDCODED_API_KEY.startsWith('sk-');
            
            if (settingsKey) {
                document.getElementById('openai-api-key').value = settingsKey;
                document.getElementById('api-status').innerHTML = '<p class="text-green-600">‚úÖ OpenAI API key from Settings (overriding hardcoded key)</p>';
            } else if (hardcodedActive) {
                document.getElementById('api-status').innerHTML = '<p class="text-blue-600">‚ÑπÔ∏è Using hardcoded OpenAI API key. You can override it here.</p>';
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function toggleDarkMode() {
            const toggle = document.getElementById('dark-mode-toggle');
            toggle.classList.toggle('active');
            document.body.classList.toggle('dark-mode');
                        document.documentElement.classList.toggle('dark');
            
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }

        function toggleNotifications() {
            const toggle = document.getElementById('notification-toggle');
            toggle.classList.toggle('active');
            
            const isEnabled = toggle.classList.contains('active');
            localStorage.setItem('notifications', isEnabled);
            
            if (isEnabled) {
                showNotification('üîî', 'Notifications Enabled', 'You will receive study reminders', 'success');
            } else {
                showNotification('üîï', 'Notifications Disabled', 'Study reminders are turned off', 'info');
            }
        }

        function openProfileSettings() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            document.getElementById('profile-name').value = currentUser.name;
            document.getElementById('profile-email').value = currentUser.email;
            document.getElementById('profile-username').value = currentUser.username;
            document.getElementById('profile-subject').value = currentUser.subject;
            
            document.getElementById('settings-modal').classList.remove('active');
            document.getElementById('profile-modal').classList.add('active');
        }

        function closeProfileSettings() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        function saveProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const username = document.getElementById('profile-username').value.trim();
            const subject = document.getElementById('profile-subject').value;

            if (!name || !email || !username || !subject) {
                showNotification('‚ö†Ô∏è', 'Missing Fields', 'Please fill in all fields', 'warning');
                return;
            }

            // Update current user
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const updatedUser = { ...currentUser, name, email, username, subject };
            localStorage.setItem('currentUser', JSON.stringify(updatedUser));

            // Update in users array
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                users[userIndex] = { ...users[userIndex], name, email, username, subject };
                localStorage.setItem('users', JSON.stringify(users));
            }

            // Update UI
            showMainApp(updatedUser);
            
            showNotification('‚úÖ', 'Profile Updated!', 'Your profile has been updated successfully', 'success');
            closeProfileSettings();
        }

        function clearCache() {
            // Clear everything except user data
            const currentUser = localStorage.getItem('currentUser');
            const users = localStorage.getItem('users');
            const darkMode = localStorage.getItem('darkMode');
            const notifications = localStorage.getItem('notifications');
            
            localStorage.clear();
            
            if (currentUser) localStorage.setItem('currentUser', currentUser);
            if (users) localStorage.setItem('users', users);
            if (darkMode) localStorage.setItem('darkMode', darkMode);
            if (notifications) localStorage.setItem('notifications', notifications);
            
            showNotification('‚úÖ', 'Cache Cleared!', 'All cached data has been cleared successfully', 'success');
        }

        function exportData() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const data = {
                user: currentUser,
                exportedAt: new Date().toISOString(),
                settings: {
                    darkMode: localStorage.getItem('darkMode'),
                    notifications: localStorage.getItem('notifications')
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bharat-academic-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showNotification('üì•', 'Data Exported!', 'Your data has been downloaded successfully', 'success');
        }

        function showPrivacyPolicy() {
            showNotification('üîí', 'Privacy Policy', 'Your data is stored locally on your device and never sent to external servers. No tracking, full privacy.', 'info');
        }

        function showAbout() {
            showNotification('‚ÑπÔ∏è', 'About Bharat Academic Copilot', 'Version 1.0.0 - AI-powered exam intelligence for Indian students. Made with ‚ù§Ô∏è', 'info');
        }

        function confirmDeleteAccount() {
            const doubleConfirm = prompt('‚ö†Ô∏è WARNING: This will permanently delete your account!\n\nType "DELETE" to confirm:');
            
            if (doubleConfirm === 'DELETE') {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                
                // Remove from users array
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const updatedUsers = users.filter(u => u.email !== currentUser.email);
                localStorage.setItem('users', JSON.stringify(updatedUsers));
                
                // Clear current user
                localStorage.removeItem('currentUser');
                
                showNotification('‚úÖ', 'Account Deleted', 'Your account has been deleted. We\'re sad to see you go!', 'success');
                
                setTimeout(() => {
                    // Redirect to login
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('auth-page').style.display = 'flex';
                    closeSettings();
                    closeNotification();
                    showLogin();
                }, 2000);
            } else if (doubleConfirm !== null) {
                showNotification('‚ùå', 'Deletion Cancelled', 'Account deletion has been cancelled', 'info');
            }
        }

        // ==================== ANALYSIS PAGE ====================

        function populateAnalysisSubjects() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const select = document.getElementById('analysis-subject-select');
            if (!select) return;

            const subjects = currentUser.subjects || [];
            if (subjects.length === 0) {
                select.innerHTML = '<option value="">No subjects uploaded yet</option>';
                return;
            }

            select.innerHTML = '<option value="">Select a subject</option>' + 
                subjects.map(s => `<option value="${s}">${s}</option>`).join('');

            // Restore last selected subject if available
            const last = localStorage.getItem('analysisLastSubject');
            if (last && subjects.includes(last)) {
                select.value = last;
            }
        }

        function estimateAnalysisMetrics(subject) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const uploads = currentUser.uploads?.[subject] || {};
            const syllabusCount = (uploads.syllabus || []).length;
            const papersCount = (uploads.papers || []).length;
            const notesCount = (uploads.notes || []).length;

            if (syllabusCount === 0 && papersCount === 0 && notesCount === 0) {
                return { topics: 0, priority: 0, coverage: 0 };
            }

            // Heuristic: each syllabus provides ~10 topics, papers add ~3 each, notes ~1 each
            const topics = syllabusCount * 10 + papersCount * 3 + notesCount * 1;
            const priority = Math.round(topics * 0.33);
            const coverage = Math.min(100, Math.round(50 + papersCount * 8 + notesCount * 3));

            return { topics, priority, coverage };
        }

        function renderAnalysisMetrics(subject) {
            if (!subject) {
                document.getElementById('analysis-topics').textContent = '0';
                document.getElementById('analysis-priority').textContent = '0';
                document.getElementById('analysis-coverage').textContent = '0%';
                return;
            }

            const m = estimateAnalysisMetrics(subject);
            document.getElementById('analysis-topics').textContent = m.topics;
            document.getElementById('analysis-priority').textContent = m.priority;
            document.getElementById('analysis-coverage').textContent = `${m.coverage}%`;
        }

        function extractTopicsFromMaterials(subject) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            
            // Check if we have AI-analyzed topics
            const aiAnalysis = currentUser.aiAnalysis?.[subject];
            if (aiAnalysis && aiAnalysis.coreTopics && aiAnalysis.coreTopics.length > 0) {
                // Use AI-extracted topics
                const allTopics = aiAnalysis.coreTopics;
                const importantTopics = aiAnalysis.importantTopics || [];
                
                // Categorize topics by priority
                const highPriority = [];
                const mediumPriority = [];
                const lowPriority = [];
                
                allTopics.forEach(topic => {
                    const priority = aiAnalysis.priorityLevels?.[topic] || 'Medium';
                    if (priority === 'High' || importantTopics.includes(topic)) {
                        highPriority.push(topic);
                    } else if (priority === 'Low') {
                        lowPriority.push(topic);
                    } else {
                        mediumPriority.push(topic);
                    }
                });
                
                return {
                    all: allTopics,
                    important: highPriority,
                    medium: mediumPriority,
                    lowPriority: lowPriority,
                    isAI: true
                };
            }
            
            // Fallback: Check if user has uploaded any files for this subject
            const uploads = currentUser.uploads?.[subject] || {};
            const papersCount = (uploads.papers || []).length;
            const syllabusCount = (uploads.syllabus || []).length;
            const notesCount = (uploads.notes || []).length;
            
            // If no files uploaded, return empty topics - don't show generic topics
            if (papersCount === 0 && syllabusCount === 0 && notesCount === 0) {
                return {
                    all: [],
                    important: [],
                    medium: [],
                    lowPriority: [],
                    isAI: false
                };
            }
            
            // Only show generic topics if files are uploaded but AI analysis hasn't been done yet
            const topicsBases = {
                'Mathematics': ['Algebra', 'Geometry', 'Trigonometry', 'Calculus', 'Probability', 'Statistics', 'Complex Numbers', 'Matrices', 'Sequences & Series', 'Integration', 'Differentiation', 'Functions', 'Linear Programming', 'Vectors'],
                'Physics': ['Mechanics', 'Thermodynamics', 'Optics', 'Electricity', 'Magnetism', 'Modern Physics', 'Waves', 'Fluids', 'Oscillations', 'Relativity', 'Quantum Mechanics', 'Nuclear Physics', 'Kinematics', 'Dynamics'],
                'Chemistry': ['Atomic Structure', 'Bonding', 'Thermodynamics', 'Kinetics', 'Equilibrium', 'Acids & Bases', 'Redox', 'Organic Chemistry', 'Inorganic Chemistry', 'Solutions', 'Electrochemistry', 'Polymers', 'Hydrocarbons', 'Alkanes & Alkenes'],
                'Biology': ['Cell Biology', 'Genetics', 'Evolution', 'Ecology', 'Botany', 'Zoology', 'Physiology', 'Biochemistry', 'Microbiology', 'Anatomy', 'Photosynthesis', 'Respiration', 'Protein Synthesis', 'Reproduction'],
                'English': ['Grammar', 'Literature', 'Comprehension', 'Writing', 'Vocabulary', 'Poetry', 'Prose', 'Drama', 'Figures of Speech', 'Idioms', 'Tenses', 'Punctuation', 'Essay Writing', 'Communication'],
                'History': ['Ancient History', 'Medieval History', 'Modern History', 'World War I', 'World War II', 'Independence Movement', 'Political Systems', 'Revolutions', 'Civilizations', 'Empires', 'Social Movements', 'Cultural History', 'Economic History', 'Geography'],
            };

            const baseTopics = topicsBases[subject] || [
                'Fundamentals', 'Theory', 'Practice', 'Applications', 'Case Studies',
                'Key Concepts', 'Advanced Topics', 'Review', 'Integration', 'Problem Solving'
            ];
            
            const totalTopics = Math.min(baseTopics.length, Math.ceil(syllabusCount * 8 + papersCount * 2 + notesCount));
            
            return {
                all: baseTopics.slice(0, Math.max(10, totalTopics)),
                important: baseTopics.slice(0, Math.ceil(totalTopics * 0.4)),
                lowPriority: baseTopics.slice(-Math.ceil(totalTopics * 0.2)),
                isAI: false
            };
        }

        function renderAnalysisTopics(subject) {
            const container = document.getElementById('analysis-topics-container');
            if (!container) return;

            if (!subject) {
                container.innerHTML = `
                    <div class="card text-center py-8 border-2 border-gray-200">
                        <p class="text-gray-500">üìö Select a subject to view detailed topic analysis</p>
                    </div>
                `;
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const uploads = currentUser.uploads?.[subject] || {};
            const papersCount = (uploads.papers || []).length;
            const syllabusCount = (uploads.syllabus || []).length;
            const notesCount = (uploads.notes || []).length;

            if (papersCount === 0 && syllabusCount === 0 && notesCount === 0) {
                container.innerHTML = `
                    <div class="card text-center py-8 border-2 border-orange-200">
                        <p class="text-gray-500">üìÅ No materials uploaded for this subject</p>
                        <p class="text-xs text-gray-400 mt-2">Upload syllabus, papers, or notes to see topic analysis</p>
                    </div>
                `;
                return;
            }

            const topics = extractTopicsFromMaterials(subject);
            
            // If no AI analysis was done AND we have no custom topics, show empty state
            if (!topics.isAI && (!topics.all || topics.all.length === 0)) {
                container.innerHTML = `
                    <div class="card text-center py-8 border-2 border-gray-300">
                        <p class="text-gray-500">üîç No topics extracted yet</p>
                        <p class="text-xs text-gray-400 mt-2">Topics will appear once files are processed with AI analysis</p>
                    </div>
                `;
                return;
            }
            
            const aiIndicator = topics.isAI ? '<span class="ml-3 text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full font-bold">ü§ñ AI Analyzed</span>' : '<span class="ml-3 text-xs bg-gray-300 text-gray-700 px-3 py-1 rounded-full">Generic Topics</span>';
            
            container.innerHTML = `
                <!-- Core Topics Section -->
                <div class="card border-2 border-blue-200 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg text-blue-700">üìñ Core Topics</h3>
                        ${aiIndicator}
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Based on ${syllabusCount} syllabus file(s) and ${papersCount} paper(s)</p>
                    ${!topics.isAI ? '<p class="text-xs text-orange-600 mb-4 p-3 bg-orange-50 rounded-lg">üí° Upload files with OpenAI API key configured to get AI-powered topic extraction from YOUR documents!</p>' : ''}
                    <div id="core-topics-list" class="space-y-2">
                        ${topics.all.map((topic, i) => `
                            <div class="p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border-l-4 border-blue-400 hover:shadow-md transition">
                                <span class="text-sm font-medium text-blue-900">${i + 1}. ${topic}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Detailed Topic Analysis Section -->
                <div class="card border-2 border-purple-200 mb-6">
                    <h3 class="font-bold text-lg mb-6 text-purple-700">üîç Detailed Topic Analysis</h3>
                    
                    <!-- Most Important Topics -->
                    <div class="mb-6">
                        <h4 class="font-bold text-red-600 mb-3 flex items-center gap-2">
                            <span class="text-lg">üî¥</span> Most Important Topics
                        </h4>
                        <div id="important-topics" class="space-y-2">
                            ${topics.important.map((topic, i) => `
                                <div class="p-3 bg-gradient-to-r from-red-50 to-orange-50 rounded-lg border-l-4 border-red-400">
                                    <span class="text-sm font-medium text-red-900">${topic}</span>
                                    <span class="ml-2 text-xs bg-red-200 text-red-700 px-2 py-1 rounded">High Priority</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Subtopics & Connected Topics -->
                    <div class="mb-6">
                        <h4 class="font-bold text-orange-600 mb-3 flex items-center gap-2">
                            <span class="text-lg">üü†</span> Subtopics & Connected Topics
                        </h4>
                        <div id="subtopics-list" class="space-y-2">
                            ${topics.all.slice(Math.ceil(topics.all.length * 0.4), Math.ceil(topics.all.length * 0.8)).map((topic) => `
                                <div class="p-3 bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg border-l-4 border-orange-400">
                                    <span class="text-sm font-medium text-orange-900">${topic}</span>
                                    <span class="ml-2 text-xs bg-orange-200 text-orange-700 px-2 py-1 rounded">Medium Priority</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Reference/Low Priority Topics -->
                    <div>
                        <h4 class="font-bold text-gray-600 mb-3 flex items-center gap-2">
                            <span class="text-lg">‚ö™</span> Reference Topics (Low Priority)
                        </h4>
                        <div id="low-priority-topics" class="space-y-2">
                            ${topics.lowPriority.map((topic) => `
                                <div class="p-3 bg-gradient-to-r from-slate-100 to-slate-200 rounded-lg border-l-4 border-slate-500 shadow-sm">
                                    <span class="text-sm font-medium text-slate-900">${topic}</span>
                                    <span class="ml-2 text-xs bg-slate-300 text-slate-900 px-2 py-1 rounded font-semibold">Low Priority</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card border-2 border-green-200 bg-gradient-to-r from-green-50 to-emerald-50">
                    <h3 class="font-bold text-lg mb-4 text-green-700">üìä Coverage Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-4 bg-white rounded-lg border border-green-200">
                            <p class="text-xs text-gray-600 mb-1">Total Topics</p>
                            <p class="text-3xl font-bold text-green-600">${topics.all.length}</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg border border-red-200">
                            <p class="text-xs text-gray-600 mb-1">High Priority</p>
                            <p class="text-3xl font-bold text-red-600">${topics.important.length}</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg border border-blue-200">
                            <p class="text-xs text-gray-600 mb-1">Materials</p>
                            <p class="text-3xl font-bold text-blue-600">${syllabusCount + papersCount + notesCount}</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg border border-purple-200">
                            <p class="text-xs text-gray-600 mb-1">Coverage</p>
                            <p class="text-3xl font-bold text-purple-600">${Math.min(100, 50 + papersCount * 10)}%</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateSmartRecommendation() {
            const subject = document.getElementById('analysis-subject-select')?.value || '';
            if (!subject) {
                showNotification('\u26a0\ufe0f', 'Select Subject', 'Please select a subject first', 'warning');
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const uploads = currentUser.uploads?.[subject] || {};
            const topics = extractTopicsFromMaterials(subject);
            
            const papersCount = (uploads.papers || []).length;
            const syllabusCount = (uploads.syllabus || []).length;
            const notesCount = (uploads.notes || []).length;
            
            const daysLeft = calculateDaysLeft(currentUser.examDate);
            const totalHours = topics.all.length * 2; // 2 hours per topic
            const dailyHours = Math.ceil(totalHours / Math.max(1, daysLeft));

            // Create study schedule/plan
            const studyPlan = {
                subject: subject,
                createdDate: new Date().toISOString(),
                examDate: currentUser.examDate,
                daysLeft: daysLeft,
                totalTopics: topics.all.length,
                highPriorityTopics: topics.important.length,
                totalHours: totalHours,
                dailyHours: dailyHours,
                files: {
                    syllabus: syllabusCount,
                    papers: papersCount,
                    notes: notesCount
                },
                phases: [
                    {
                        name: 'Phase 1: High Priority Topics',
                        duration: Math.ceil(daysLeft * 0.5),
                        hours: Math.ceil(totalHours * 0.6),
                        topics: topics.important.slice(0, Math.ceil(topics.important.length * 0.6)),
                        description: 'Focus on high-frequency topics from past papers'
                    },
                    {
                        name: 'Phase 2: Medium Priority & Subtopics',
                        duration: Math.ceil(daysLeft * 0.3),
                        hours: Math.ceil(totalHours * 0.25),
                        topics: topics.all.slice(Math.ceil(topics.all.length * 0.4), Math.ceil(topics.all.length * 0.8)),
                        description: 'Cover subtopics and connected topics from syllabus'
                    },
                    {
                        name: 'Phase 3: Revision & Practice',
                        duration: Math.ceil(daysLeft * 0.2),
                        hours: Math.ceil(totalHours * 0.15),
                        topics: topics.lowPriority,
                        description: 'Final revision and practice with past papers'
                    }
                ]
            };

            // Save to study plans
            if (!currentUser.studyPlans) {
                currentUser.studyPlans = {};
            }
            currentUser.studyPlans[subject] = studyPlan;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            renderRecommendationDisplay(studyPlan);
            showNotification('‚úÖ', 'Study Plan Created', `Generated ${studyPlan.phases.length}-phase study schedule for ${subject}`, 'success');
        }

        function calculateDaysLeft(examDate) {
            if (!examDate) return 30;
            const today = new Date();
            const exam = new Date(examDate);
            const diff = exam - today;
            return Math.max(1, Math.ceil(diff / (1000 * 60 * 60 * 24)));
        }

        function renderRecommendationDisplay(plan) {
            const container = document.getElementById('recommendation-display');
            if (!container) return;

            const phaseHtml = plan.phases.map((phase, idx) => `
                <div class="p-4 bg-white rounded-lg border-l-4 ${idx === 0 ? 'border-red-500' : idx === 1 ? 'border-orange-500' : 'border-green-500'}">
                    <p class="font-bold ${idx === 0 ? 'text-red-700' : idx === 1 ? 'text-orange-700' : 'text-green-700'}">${phase.name}</p>
                    <p class="text-xs text-gray-600 mt-1">${phase.description}</p>
                    <div class="grid grid-cols-3 gap-2 mt-3 text-xs">
                        <div><span class="text-gray-500">Duration:</span> <span class="font-bold">${phase.duration} days</span></div>
                        <div><span class="text-gray-500">Hours:</span> <span class="font-bold">${phase.hours}h</span></div>
                        <div><span class="text-gray-500">Topics:</span> <span class="font-bold">${phase.topics.length}</span></div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <p class="text-xs font-semibold text-gray-700 mb-2">Topics in this phase:</p>
                        <div class="flex flex-wrap gap-2">
                            ${phase.topics.slice(0, 5).map(t => `<span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-700">${t}</span>`).join('')}
                            ${phase.topics.length > 5 ? `<span class="text-xs text-gray-500">+${phase.topics.length - 5} more</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            const html = `
                <div class="card border-2 border-green-200 bg-gradient-to-r from-green-50 to-emerald-50">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-2xl font-bold mb-2">üìÖ ${plan.subject} Study Schedule</h3>
                            <p class="text-gray-600">Personalized ${plan.phases.length}-phase study plan based on your uploaded materials</p>
                        </div>
                        <button onclick="downloadSchedulePDF('${plan.subject}')" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-bold hover:shadow-glow">üì• Download Schedule</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="p-4 bg-white rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-600 mb-1">Days Left</p>
                            <p class="text-3xl font-bold text-blue-600">${plan.daysLeft}</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-600 mb-1">Total Topics</p>
                            <p class="text-3xl font-bold text-purple-600">${plan.totalTopics}</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-600 mb-1">Daily Study</p>
                            <p class="text-3xl font-bold text-orange-600">${plan.dailyHours}h</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-600 mb-1">Total Hours</p>
                            <p class="text-3xl font-bold text-green-600">${plan.totalHours}h</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-bold text-lg mb-4 flex items-center gap-2">üìã Recommended Study Phases</h4>
                        <div class="space-y-3">
                            ${phaseHtml}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-white rounded-lg border border-blue-200">
                            <p class="text-xs text-gray-600 mb-2">üìö Materials Uploaded</p>
                            <div class="space-y-1 text-sm">
                                <p class="font-semibold"><span class="text-blue-600">${plan.files.syllabus}</span> syllabus file(s)</p>
                                <p class="font-semibold"><span class="text-red-600">${plan.files.papers}</span> past paper(s)</p>
                                <p class="font-semibold"><span class="text-green-600">${plan.files.notes}</span> note(s)</p>
                            </div>
                        </div>
                        <div class="p-4 bg-white rounded-lg border border-purple-200">
                            <p class="text-xs text-gray-600 mb-2">üéØ Priority Breakdown</p>
                            <div class="space-y-1 text-sm">
                                <p class="font-semibold"><span class="text-red-600">${plan.highPriorityTopics}</span> high-priority topics</p>
                                <p class="font-semibold"><span class="text-orange-600">${Math.ceil(plan.totalTopics * 0.4)}</span> medium-priority topics</p>
                                <p class="font-semibold"><span class="text-gray-600">${Math.ceil(plan.totalTopics * 0.2)}</span> low-priority topics</p>
                            </div>
                        </div>
                        <div class="p-4 bg-white rounded-lg border border-green-200">
                            <p class="text-xs text-gray-600 mb-2">üí° Key Recommendations</p>
                            <ul class="text-xs text-gray-600 space-y-1">
                                <li>‚úì Study ${plan.dailyHours}h daily</li>
                                <li>‚úì Focus 60% on high-priority topics</li>
                                <li>‚úì Practice with past papers regularly</li>
                            </ul>
                        </div>
                    </div>

                    <button onclick="closeRecommendationDisplay()" class="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300">Close</button>
                </div>
            `;

            container.innerHTML = html;
            container.style.display = 'block';

            // Save study plan for download
            localStorage.setItem(`plan_${plan.subject}`, JSON.stringify(plan));
        }

        function closeRecommendationDisplay() {
            const container = document.getElementById('recommendation-display');
            if (container) {
                container.style.display = 'none';
            }
        }

        function downloadSchedulePDF(subject) {
            const plan = JSON.parse(localStorage.getItem(`plan_${subject}`) || '{}');
            if (!plan.subject) {
                showNotification('‚ùå', 'Error', 'Study plan not found', 'error');
                return;
            }

            const { jsPDF } = window.jspdf || {};
            if (!jsPDF) {
                showNotification('‚ùå', 'PDF Error', 'PDF library not loaded', 'error');
                return;
            }

            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text(`Study Schedule: ${subject}`, 14, 20);
            
            let y = 35;
            doc.setFontSize(11);
            doc.text(`Exam Date: ${plan.examDate || 'Not set'} | Days Left: ${plan.daysLeft}`, 14, y);
            
            y += 15;
            doc.setFontSize(12);
            doc.text('Overview:', 14, y);
            
            y += 8;
            doc.setFontSize(10);
            doc.text(`‚Ä¢ Total Topics: ${plan.totalTopics}`, 14, y);
            y += 6;
            doc.text(`‚Ä¢ High Priority: ${plan.highPriorityTopics}`, 14, y);
            y += 6;
            doc.text(`‚Ä¢ Daily Study Time: ${plan.dailyHours} hours`, 14, y);
            y += 6;
            doc.text(`‚Ä¢ Total Study Hours: ${plan.totalHours} hours`, 14, y);
            y += 6;
            doc.text(`‚Ä¢ Materials: ${plan.files.syllabus} syllabus, ${plan.files.papers} papers, ${plan.files.notes} notes`, 14, y);
            
            y += 12;
            doc.setFontSize(12);
            doc.text('Study Phases:', 14, y);
            
            y += 8;
            doc.setFontSize(10);
            plan.phases.forEach((phase, idx) => {
                doc.text(`${phase.name}`, 14, y);
                y += 6;
                doc.text(`Duration: ${phase.duration} days | Hours: ${phase.hours}h | Topics: ${phase.topics.length}`, 18, y);
                y += 6;
                doc.text(`${phase.description}`, 18, y);
                y += 8;
                
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            doc.save(`StudySchedule_${subject}.pdf`);
            showNotification('üì•', 'Schedule Downloaded', 'Your study schedule has been saved as PDF', 'success');
        }

        function initAnalysis() {
            populateAnalysisSubjects();
            const select = document.getElementById('analysis-subject-select');
            if (select && !select.__wired) {
                select.addEventListener('change', function() {
                    const subject = this.value;
                    localStorage.setItem('analysisLastSubject', subject);
                    renderAnalysisMetrics(subject);
                    renderAnalysisTopics(subject);
                    closeRecommendationDisplay();
                });
                select.__wired = true;
            }
            const subject = document.getElementById('analysis-subject-select')?.value || '';
            if (subject) {
                renderAnalysisMetrics(subject);
                renderAnalysisTopics(subject);
            }
        }

        // Initialize analysis when page becomes active
        document.addEventListener('DOMContentLoaded', function() {
            const analysisPage = document.getElementById('analysis');
            if (analysisPage) {
                const observer = new MutationObserver(function() {
                    if (analysisPage.classList.contains('active')) {
                        initAnalysis();
                    }
                });
                observer.observe(analysisPage, { attributes: true, attributeFilter: ['class'] });
            }
        });

        // ==================== NAVIGATION ====================

        // ==================== DASHBOARD ====================

        function hasUploads() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const uploads = currentUser.uploads || {};
            return Object.keys(uploads).some(subject => {
                const files = uploads[subject];
                return (files.syllabus && files.syllabus.length > 0) ||
                       (files.papers && files.papers.length > 0) ||
                       (files.notes && files.notes.length > 0);
            });
        }

        function hasSyllabusUploads() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const uploads = currentUser.uploads || {};
            return Object.keys(uploads).some(subject => {
                const files = uploads[subject];
                return (files.syllabus && files.syllabus.length > 0);
            });
        }

        function startExamMode() {
            // Show custom exam date modal
            const overlay = document.getElementById('exam-date-overlay');
            const modal = document.getElementById('exam-date-modal');
            const input = document.getElementById('exam-date-input');
            
            // Set min date to today
            const today = new Date();
            input.min = today.toISOString().split('T')[0];
            input.value = '';
            
            overlay.classList.add('show');
            modal.classList.add('show');
            
            // Focus input after animation
            setTimeout(() => input.focus(), 300);
        }

        function cancelExamDate() {
            const overlay = document.getElementById('exam-date-overlay');
            const modal = document.getElementById('exam-date-modal');
            overlay.classList.remove('show');
            modal.classList.remove('show');
        }

        function confirmExamDate() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const dateInput = document.getElementById('exam-date-input').value;
            
            if (!dateInput) {
                showNotification('‚ö†Ô∏è', 'Date Required', 'Please select an exam date', 'warning');
                return;
            }
            
            try {
                const examDate = new Date(dateInput);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                examDate.setHours(0, 0, 0, 0);
                
                if (examDate < today) {
                    showNotification('‚ö†Ô∏è', 'Invalid Date', 'Exam date must be in the future', 'warning');
                    return;
                }
                
                // Close modal
                cancelExamDate();
                
                // Update user exam date
                currentUser.examDate = dateInput;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Update in users array
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const idx = users.findIndex(u => u.email === currentUser.email);
                if (idx !== -1) {
                    users[idx].examDate = dateInput;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                // Recalculate and update days left
                const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
                
                showNotification('üéØ', 'Exam Mode Activated!', `You have ${daysLeft} days to prepare. Let's make them count!`, 'success');
                
                // Refresh UI
                showMainApp(currentUser);
                
            } catch (err) {
                showNotification('‚ùå', 'Invalid Date', 'Please select a valid exam date', 'error');
            }
        }

        function viewSyllabus() {
            if (!hasSyllabusUploads()) {
                showNotification('üìÅ', 'Upload Syllabus First', 'Please upload your syllabus files to view them', 'warning');
                setTimeout(() => {
                    closeNotification();
                    goToPage('upload');
                }, 2000);
            } else {
                renderSyllabusPreview();
                document.getElementById('syllabus-modal').classList.add('active');
            }
        }

        function closeSyllabusModal() {
            document.getElementById('syllabus-modal').classList.remove('active');
        }

        function renderSyllabusPreview() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const uploads = currentUser.uploads || {};
            const container = document.getElementById('syllabus-preview-content');
            if (!container) return;

            const subjects = Object.keys(uploads).filter(subj => 
                uploads[subj].syllabus && uploads[subj].syllabus.length > 0
            );

            if (subjects.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No syllabus uploaded yet.</p>';
                return;
            }

            container.innerHTML = subjects.map(subj => {
                const files = uploads[subj].syllabus || [];
                const fileList = files.map(f => f.name).join(', ');
                return `
                    <div class="p-4 border border-gray-200 rounded-xl bg-gradient-to-r from-purple-50 to-pink-50">
                        <h3 class="font-bold text-lg mb-2">üìö ${subj}</h3>
                        <p class="text-sm text-gray-600 mb-2"><strong>${files.length}</strong> file(s) uploaded</p>
                        <p class="text-xs text-gray-500 truncate">${fileList}</p>
                        <p class="text-xs text-gray-500 mt-2">üí° AI will parse these files to extract topics and patterns</p>
                    </div>
                `;
            }).join('');
        }

        function estimateDashboardMetrics() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            
            // Get time spent on website (in minutes)
            const sessionStart = sessionStorage.getItem('sessionStartTime');
            const totalTime = localStorage.getItem(`timeOnWebsite_${currentUser.email}`) || 0;
            let currentSessionTime = 0;
            
            if (sessionStart) {
                currentSessionTime = Math.floor((Date.now() - parseInt(sessionStart)) / 1000 / 60);
            }
            
            const totalMinutes = parseInt(totalTime) + currentSessionTime;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            return { hours: `${hours}h ${minutes}m` };
        }

        function renderDashboardMetrics() {
            const m = estimateDashboardMetrics();
            const hoursEl = document.getElementById('dash-hours');
            const subjectsEl = document.getElementById('dash-subjects-list');

            // Render subjects list with improved contrast
            if (subjectsEl) {
                const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
                const subjects = currentUser.subjects || [];
                
                if (subjects.length === 0) {
                    subjectsEl.innerHTML = '<p class="text-gray-400 text-xs">No subjects yet</p>';
                } else {
                    subjectsEl.innerHTML = subjects.map(s => `
                        <div class="flex items-center justify-between bg-slate-700 px-3 py-2 rounded-lg border border-slate-600">
                            <span class="text-sm font-semibold text-white">${s}</span>
                        </div>
                    `).join('');
                }
            }

            if (hoursEl) hoursEl.textContent = m.hours;
        }

        function renderHighPriorityTopics() {
            // Function removed - no longer needed
        }

        function handleGenerateAnswers() {
            if (!hasUploads()) {
                showNotification('üìÅ', 'Upload Files First', 'Please upload your syllabus and past papers to generate exam answers', 'warning');
                setTimeout(() => {
                    closeNotification();
                    goToPage('upload');
                }, 2000);
            } else {
                goToPage('answers');
            }
        }

        function initDashboard() {
            renderDashboardMetrics();
            // Start tracking time on website
            if (!sessionStorage.getItem('sessionStartTime')) {
                sessionStorage.setItem('sessionStartTime', Date.now().toString());
            }
            // Update time every minute
            setInterval(() => {
                renderDashboardMetrics();
            }, 60000);
            // Check for passed sessions
            checkPassedSessions();
            setInterval(checkPassedSessions, 60000); // Check every minute
        }

        // Check if any session time has passed and show completion prompt
        function checkPassedSessions() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const now = new Date();
            const today = now.toLocaleDateString();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            const subjects = currentUser.subjects || [];
            subjects.forEach(subject => {
                const plans = (currentUser.studyPlans && currentUser.studyPlans[subject]) || [];
                plans.forEach((session, index) => {
                    try {
                        const sessionDate = new Date(session.date).toLocaleDateString();
                        if (sessionDate === today && !session.completed && session.end <= currentTime) {
                            // Session has passed and not marked complete
                            const lastPrompted = sessionStorage.getItem(`prompted_${subject}_${index}`);
                            if (!lastPrompted) {
                                sessionStorage.setItem(`prompted_${subject}_${index}`, 'true');
                                // Show completion modal after a small delay
                                setTimeout(() => markSessionCompletion(subject, index), 2000);
                            }
                        }
                    } catch {}
                });
            });
        }

        // ==================== NAVIGATION ====================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.transform = sidebar.style.transform === 'translateX(-100%)' ? 'translateX(0)' : 'translateX(-100%)';
        }

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (window.innerWidth < 768) document.getElementById('sidebar').style.transform = 'translateX(-100%)';
            });
        });

        if (window.innerWidth >= 768) {
            document.getElementById('sidebar').style.transform = 'translateX(0)';
        } else {
            document.getElementById('sidebar').style.transform = 'translateX(-100%)';
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // Track time spent on website
        window.addEventListener('beforeunload', function() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const sessionStart = sessionStorage.getItem('sessionStartTime');
            if (!sessionStart) return;
            
            const currentSessionTime = Math.floor((Date.now() - parseInt(sessionStart)) / 1000 / 60);
            const totalTime = parseInt(localStorage.getItem(`timeOnWebsite_${currentUser.email}`) || 0);
            localStorage.setItem(`timeOnWebsite_${currentUser.email}`, (totalTime + currentSessionTime).toString());
        });

        // Notification Panel Functions
        let notificationPanelTimeout = null;

        function showNotificationPanel() {
            clearTimeout(notificationPanelTimeout);
            const panel = document.getElementById('notification-panel');
            if (!panel) return;
            
            // Get today's sessions
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const today = new Date().toLocaleDateString();
            const todaySessions = [];
            
            const subjects = currentUser.subjects || [];
            subjects.forEach(subject => {
                const plans = (currentUser.studyPlans && currentUser.studyPlans[subject]) || [];
                plans.forEach((session, index) => {
                    try {
                        if (new Date(session.date).toLocaleDateString() === today) {
                            todaySessions.push({ ...session, subject, index });
                        }
                    } catch {}
                });
            });
            
            // Populate panel
            const listEl = document.getElementById('notification-sessions-list');
            if (todaySessions.length === 0) {
                listEl.innerHTML = '<p class="text-xs text-gray-500">No sessions scheduled for today</p>';
            } else {
                listEl.innerHTML = todaySessions.sort((a, b) => a.start > b.start ? 1 : -1).map(s => {
                    const isCompleted = s.completed;
                    const statusIcon = isCompleted ? '‚úÖ' : '‚è∞';
                    const statusColor = isCompleted ? 'text-green-600' : 'text-orange-600';
                    return `
                        <div class="p-2 rounded-lg border ${isCompleted ? 'bg-green-100 border-green-300' : 'bg-gray-50 border-gray-200'}">
                            <div class="flex items-center justify-between">
                                <p class="text-xs font-semibold ${statusColor}">${statusIcon} ${s.subject}</p>
                                <span class="text-xs text-gray-500">${format12Hour(s.start)} - ${format12Hour(s.end)}</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">${s.type}: ${s.topic}</p>
                        </div>
                    `;
                }).join('');
            }
            
            // Show badge if there are pending sessions
            const badge = document.getElementById('notification-badge');
            const pendingSessions = todaySessions.filter(s => !s.completed);
            if (badge && pendingSessions.length > 0) {
                badge.classList.remove('hidden');
            }
            
            panel.style.display = 'block';
        }

        function hideNotificationPanel() {
            notificationPanelTimeout = setTimeout(() => {
                const panel = document.getElementById('notification-panel');
                if (panel) panel.style.display = 'none';
            }, 300);
        }

        // ==================== STUDY PLANNER ====================

        function populatePlannerSubjects() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const select = document.getElementById('planner-subject-select');
            if (!select) return;

            const subjects = currentUser.subjects || [];
            if (subjects.length === 0) {
                select.innerHTML = '<option value="">Add subjects in Upload page</option>';
                return;
            }
            select.innerHTML = '<option value="">Select a subject</option>' + subjects.map(s => `<option value="${s}">${s}</option>`).join('');

            // Restore last selected subject if available
            const last = localStorage.getItem('plannerLastSubject');
            if (last && subjects.includes(last)) {
                select.value = last;
            }
        }

        function updatePlannerDaysLeft() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const examDate = currentUser.examDate ? new Date(currentUser.examDate) : null;
            const el = document.getElementById('planner-days-left');
            if (!el) return;
            if (!examDate) {
                el.textContent = 'Set your exam date during signup to enable countdown';
                return;
            }
            const today = new Date();
            const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
            if (daysLeft > 0) el.textContent = `${daysLeft} days until exam ‚Ä¢ Optimize your schedule`;
            else if (daysLeft === 0) el.textContent = `Exam Today! Make final revisions`;
            else el.textContent = `Exam date has passed`;
        }

        function estimatePlannerMetrics(subject) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const uploads = currentUser.uploads?.[subject] || {};
            const syllabusCount = (uploads.syllabus || []).length;
            const papersCount = (uploads.papers || []).length;
            const notesCount = (uploads.notes || []).length;

            const topicsTotal = syllabusCount > 0 ? 12 : 8;
            const topicsCovered = Math.min(topicsTotal, Math.round(papersCount * 2 + notesCount * 1));
            const topicsLeft = Math.max(0, topicsTotal - topicsCovered);

            const today = new Date();
            const examDate = currentUser.examDate ? new Date(currentUser.examDate) : today;
            const daysLeft = Math.max(1, Math.ceil((examDate - today) / (1000 * 60 * 60 * 24)));

            const totalHours = Math.round(topicsLeft * 2 + papersCount * 1.5 + notesCount * 1);
            const progressPercent = topicsTotal > 0 ? Math.round((topicsCovered / topicsTotal) * 100) : 0;
            const expectedScore = Math.max(50, Math.min(95, Math.round(50 + papersCount * 5 + notesCount * 2 + (topicsCovered) * 3)));

            return { topicsTotal, topicsCovered, topicsLeft, totalHours, progressPercent, expectedScore, daysLeft };
        }

        function renderPlannerMetrics(subject) {
            const m = estimatePlannerMetrics(subject);
            const hoursEl = document.getElementById('planner-total-hours');
            const progressEl = document.getElementById('planner-progress');
            const topicsLeftEl = document.getElementById('planner-topics-left');
            const scoreEl = document.getElementById('planner-expected-score');
            if (hoursEl) hoursEl.textContent = `${m.totalHours}h`;
            if (progressEl) progressEl.textContent = `${m.progressPercent}%`;
            if (topicsLeftEl) topicsLeftEl.textContent = `${m.topicsLeft}`;
            if (scoreEl) scoreEl.textContent = `${m.expectedScore}%`;
        }

        function renderPlannerSessions(subject) {
            const container = document.getElementById('planner-sessions');
            if (!container) return;
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const plans = (currentUser.studyPlans && currentUser.studyPlans[subject]) || [];
            if (!subject) {
                container.innerHTML = '<p class="text-sm text-gray-500">Select a subject to view sessions.</p>';
                return;
            }
            if (plans.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No sessions yet. Add your first session above.</p>';
                return;
            }
            container.innerHTML = plans.map((p, i) => {
                const dur = computeDuration(p.start, p.end);
                const startTime = format12Hour(p.start);
                const endTime = format12Hour(p.end);
                return `
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                        <div class="text-sm">
                            <p class="font-semibold text-gray-900">${formatDate(p.date)} ‚Ä¢ ${startTime} - ${endTime}</p>
                            <p class="text-gray-600">${p.type} ‚Ä¢ ${p.topic} ‚Ä¢ ${dur}</p>
                        </div>
                        <button onclick="deletePlannerSession('${subject}', ${i})" class="text-red-600 hover:text-red-700 font-bold">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        function startOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 Sun .. 6 Sat
            const diff = (day === 0 ? -6 : 1 - day); // Monday start
            d.setDate(d.getDate() + diff);
            d.setHours(0,0,0,0);
            return d;
        }

        function renderPlannerTimetable(subject) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const weekStart = startOfWeek(new Date());
            const days = ['mon','tue','wed','thu','fri','sat','sun'];

            // Collect all sessions across subjects
            const subjects = currentUser.subjects || [];
            const allSessions = [];
            subjects.forEach(subj => {
                const list = (currentUser.studyPlans && currentUser.studyPlans[subj]) || [];
                list.forEach((p, idx) => allSessions.push({ subject: subj, index: idx, ...p }));
            });

            // Clear cells
            days.forEach(id => {
                const cell = document.getElementById(`tt-${id}`);
                if (cell) cell.innerHTML = '';
            });

            // Week range label
            const rangeEl = document.getElementById('timetable-week-range');
            if (rangeEl) {
                const end = new Date(weekStart); end.setDate(end.getDate() + 6);
                rangeEl.textContent = `${weekStart.toLocaleDateString()} - ${end.toLocaleDateString()}`;
            }

            // Helper to color-code by subject
            function subjectColor(name) {
                const palette = ['#ef4444','#f59e0b','#eab308','#22c55e','#3b82f6','#a78bfa','#ec4899'];
                let hash = 0; for (let i = 0; i < name.length; i++) hash = (hash * 31 + name.charCodeAt(i)) >>> 0;
                return palette[hash % palette.length];
            }

            // Group and render by weekday
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dateStr = dayDate.toLocaleDateString();
                const dayId = days[i];
                const cell = document.getElementById(`tt-${dayId}`);
                if (!cell) continue;

                const daySessions = allSessions.filter(p => {
                    try { return new Date(p.date).toLocaleDateString() === dateStr; } catch { return false; }
                }).sort((a,b) => (a.start > b.start ? 1 : -1));

                if (daySessions.length === 0) {
                    cell.innerHTML = '<p class="text-xs text-gray-500">No sessions</p>';
                    continue;
                }

                cell.innerHTML = daySessions.map(p => {
                    const dur = computeDuration(p.start, p.end);
                    const color = subjectColor(p.subject || '');
                    const isCompleted = p.completed ? '‚úì' : '';
                    const completedBg = p.completed ? 'bg-green-300' : '';
                    const completedBorder = p.completed ? 'border border-green-600' : '';
                    return `
                        <div class="timetable-session ${completedBg} ${completedBorder}" style="border-left: 4px solid ${color}; cursor: pointer;" onclick="markSessionCompletion('${p.subject}', ${p.index})">
                            <p class="text-xs font-semibold ${p.completed ? 'text-green-700' : ''}" style="color:${!p.completed ? color : ''}">${p.subject} ${isCompleted}</p>
                            <p class="text-xs">${format12Hour(p.start)} - ${format12Hour(p.end)} ‚Ä¢ ${p.type}</p>
                            <p class="text-xs text-gray-600">${p.topic} ‚Ä¢ ${dur}</p>
                        </div>
                    `;
                }).join('');
            }
        }

        function computeDuration(start, end) {
            try {
                const [sh, sm] = start.split(':').map(Number);
                const [eh, em] = end.split(':').map(Number);
                const mins = (eh * 60 + em) - (sh * 60 + sm);
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return `${h}h ${m}m`;
            } catch {
                return '';
            }
        }

        // Convert 24-hour time to 12-hour format
        function format12Hour(time24) {
            try {
                const [hours, minutes] = time24.split(':').map(Number);
                const period = hours >= 12 ? 'PM' : 'AM';
                const hours12 = hours % 12 || 12;
                return `${hours12}:${String(minutes).padStart(2, '0')} ${period}`;
            } catch {
                return time24;
            }
        }

        function formatDate(d) {
            try { return new Date(d).toLocaleDateString(); } catch { return d; }
        }

        function addPlannerSession() {
            const subject = document.getElementById('planner-subject-select')?.value || '';
            if (!subject) {
                showNotification('‚ö†Ô∏è', 'Choose Subject', 'Please select a subject first', 'warning');
                return;
            }

            const date = document.getElementById('planner-date').value;
            const start = document.getElementById('planner-start').value;
            const end = document.getElementById('planner-end').value;
            const type = document.getElementById('planner-type').value;
            const topic = document.getElementById('planner-topic').value.trim();

            if (!date || !start || !end || !type || !topic) {
                showNotification('‚ö†Ô∏è', 'Missing Fields', 'Please fill all session details', 'warning');
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            if (!currentUser.studyPlans) currentUser.studyPlans = {};
            if (!currentUser.studyPlans[subject]) currentUser.studyPlans[subject] = [];
            currentUser.studyPlans[subject].push({ date, start, end, type, topic, createdAt: new Date().toISOString() });
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Persist last selected subject
            localStorage.setItem('plannerLastSubject', subject);

            // Mirror to users array
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const idx = users.findIndex(u => u.email === currentUser.email);
            if (idx !== -1) {
                users[idx].studyPlans = currentUser.studyPlans;
                localStorage.setItem('users', JSON.stringify(users));
            }

            // Clear inputs
            document.getElementById('planner-topic').value = '';

            showNotification('‚úÖ', 'Session Added', `Your ${type} session has been scheduled`, 'success');

            renderPlannerSessions(subject);
            renderPlannerMetrics(subject);
            renderPlannerTimetable(subject);
        }

        function deletePlannerSession(subject, index) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const plans = currentUser.studyPlans?.[subject] || [];
            if (!plans[index]) return;
            plans.splice(index, 1);
            currentUser.studyPlans[subject] = plans;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const idx = users.findIndex(u => u.email === currentUser.email);
            if (idx !== -1) {
                users[idx].studyPlans = currentUser.studyPlans;
                localStorage.setItem('users', JSON.stringify(users));
            }

            showNotification('üóëÔ∏è', 'Session Removed', 'The session has been deleted', 'info');
            renderPlannerSessions(subject);
            renderPlannerMetrics(subject);
            renderPlannerTimetable(subject);
        }

        // Session Completion Tracking
        let pendingSessionCompletion = null;

        function markSessionCompletion(subject, index) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const plans = currentUser.studyPlans?.[subject] || [];
            const session = plans[index];
            
            if (!session) return;

            // If already completed, toggle to uncomplete it
            if (session.completed) {
                uncompleteSession(subject, index);
                return;
            }

            // Store pending completion
            pendingSessionCompletion = { subject, index, session };

            // Show modal
            const overlay = document.getElementById('session-complete-overlay');
            const modal = document.getElementById('session-complete-modal');
            const details = document.getElementById('session-complete-details');
            
            details.textContent = `${session.type} session: ${session.topic} (${format12Hour(session.start)} - ${format12Hour(session.end)})`;
            
            overlay.classList.add('show');
            modal.classList.add('show');
        }

        function uncompleteSession(subject, index) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            
            if (!currentUser.studyPlans?.[subject]?.[index]) return;

            // Mark as not completed
            currentUser.studyPlans[subject][index].completed = false;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Sync to users array
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                if (!users[userIndex].studyPlans) users[userIndex].studyPlans = {};
                users[userIndex].studyPlans[subject] = currentUser.studyPlans[subject];
                localStorage.setItem('users', JSON.stringify(users));
            }

            // Re-render
            renderPlannerSessions(subject);
            renderPlannerTimetable(subject);
            
            showNotification('‚Ü©Ô∏è', 'Session Unmarked', 'Session marked as incomplete', 'info');
        }

        function confirmSessionCompletion() {
            if (!pendingSessionCompletion) return;

            const { subject, index } = pendingSessionCompletion;
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            
            if (!currentUser.studyPlans?.[subject]?.[index]) return;

            // Mark as completed
            currentUser.studyPlans[subject][index].completed = true;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Sync to users array
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                if (!users[userIndex].studyPlans) users[userIndex].studyPlans = {};
                users[userIndex].studyPlans[subject] = currentUser.studyPlans[subject];
                localStorage.setItem('users', JSON.stringify(users));
            }

            // Close modal first
            pendingSessionCompletion = null;
            const overlay = document.getElementById('session-complete-overlay');
            const modal = document.getElementById('session-complete-modal');
            overlay.classList.remove('show');
            modal.classList.remove('show');

            // Re-render timetable - this will pick up the completed flag and apply green styles
            setTimeout(() => {
                renderPlannerSessions(subject);
                renderPlannerTimetable(subject);
                showNotification('‚úÖ', 'Session Completed', 'Great work! Session marked as complete', 'success');
            }, 100);
        }

        function cancelSessionCompletion() {
            pendingSessionCompletion = null;
            const overlay = document.getElementById('session-complete-overlay');
            const modal = document.getElementById('session-complete-modal');
            overlay.classList.remove('show');
            modal.classList.remove('show');
        }

        function downloadPlanPDF() {
            const subject = document.getElementById('planner-subject-select')?.value || '';
            if (!subject) {
                showNotification('‚ö†Ô∏è', 'Choose Subject', 'Select a subject before exporting', 'warning');
                return;
            }
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const plans = (currentUser.studyPlans && currentUser.studyPlans[subject]) || [];
            const m = estimatePlannerMetrics(subject);
            const { jsPDF } = window.jspdf || {};
            if (!jsPDF) {
                showNotification('‚ùå', 'PDF Error', 'PDF library not loaded. Check network/JS.', 'error');
                return;
            }
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text(`Study Schedule ‚Ä¢ ${subject}`, 14, 20);
            doc.setFontSize(12);
            doc.text(`Student: ${currentUser.name || ''} (@${currentUser.username || ''})`, 14, 30);
            doc.text(`Days left: ${m.daysLeft} ‚Ä¢ Expected Score: ${m.expectedScore}%`, 14, 38);
            doc.text(`Total Hours: ${m.totalHours} ‚Ä¢ Progress: ${m.progressPercent}% ‚Ä¢ Topics Left: ${m.topicsLeft}`, 14, 46);
            doc.text('Sessions:', 14, 58);

            let y = 66;
            if (plans.length === 0) {
                doc.text('No sessions scheduled.', 14, y);
            } else {
                plans.forEach(p => {
                    const line = `${formatDate(p.date)} ‚Ä¢ ${p.start}-${p.end} ‚Ä¢ ${p.type} ‚Ä¢ ${p.topic}`;
                    doc.text(line, 14, y);
                    y += 8;
                    if (y > 280) { doc.addPage(); y = 20; }
                });
            }
            doc.save(`StudyPlan_${subject}.pdf`);
            showNotification('üì•', 'Schedule Exported', 'Your study schedule PDF has been downloaded', 'success');
        }

        // ==================== ANSWERS PAGE FUNCTIONS ====================

        function populateAnswersSubjects() {
            const user = getCurrentUser();
            if (!user) return;

            const select = document.getElementById('answers-subject-select');
            select.innerHTML = '<option value="">Select a subject</option>';
            user.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                select.appendChild(option);
            });

            // Restore last selected subject
            const lastSubject = localStorage.getItem('answersLastSubject');
            if (lastSubject && select.querySelector(`option[value="${lastSubject}"]`)) {
                select.value = lastSubject;
            }
        }

        function populateAnswersTopics(subject) {
            const user = getCurrentUser();
            const topicSelect = document.getElementById('answers-topic-select');
            const emptyState = document.getElementById('answers-empty-state');
            const qaDisplay = document.getElementById('answers-qa-display');
            const history = document.getElementById('answers-history');

            topicSelect.innerHTML = '<option value="">Choose a topic</option>';

            if (!user || !subject) {
                emptyState.style.display = 'block';
                qaDisplay.style.display = 'none';
                if (history) history.style.display = 'none';
                return;
            }

            // Reuse the same topic source as the Analysis page so both views stay in sync
            const topicsBundle = extractTopicsFromMaterials(subject);
            const topics = Array.from(new Set(topicsBundle?.all || []));

            if (topics.length === 0) {
                emptyState.style.display = 'block';
                qaDisplay.style.display = 'none';
                if (history) history.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';

            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });
        }

        function selectAnswerMarks(marks) {
            // Update UI to highlight selected marks
            const buttons = document.querySelectorAll('#answers-marks-container button');
            buttons.forEach(btn => {
                if (btn.textContent.includes(marks)) {
                    btn.className = 'w-full px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg';
                } else {
                    btn.className = 'w-full px-4 py-3 bg-gray-100 rounded-lg';
                }
            });
            // Store selected marks in window object for generation
            window.selectedAnswerMarks = marks;
        }

        function selectAnswerType(type) {
            window.selectedAnswerType = type;
            const mcqBtn = document.getElementById('btn-type-mcq');
            const longBtn = document.getElementById('btn-type-long');

            if (type === 'mcq') {
                mcqBtn.className = 'w-full px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg';
                longBtn.className = 'w-full px-4 py-3 bg-gray-100 rounded-lg hover:bg-green-100';
            } else {
                longBtn.className = 'w-full px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg';
                mcqBtn.className = 'w-full px-4 py-3 bg-gray-100 rounded-lg hover:bg-blue-100';
            }
        }

        async function generateAnswer() {
            const subject = document.getElementById('answers-subject-select').value;
            const topic = document.getElementById('answers-topic-select').value;
            const marks = window.selectedAnswerMarks || 10;
            const type = window.selectedAnswerType || 'long';

            if (!subject || !topic) {
                showNotification('‚ö†Ô∏è', 'Missing Fields', 'Please select a subject and topic', 'warning');
                return;
            }

            // Show loading indicator
            const loadingEl = document.getElementById('answer-loading');
            const generateBtn = document.getElementById('generate-btn');
            loadingEl.style.display = 'block';
            generateBtn.disabled = true;
            generateBtn.style.opacity = '0.5';
            generateBtn.style.cursor = 'not-allowed';

            let qa = null;
            const apiKey = getApiKey();

            try {
                if (apiKey) {
                    try {
                        qa = await generateAIQA({ subject, topic, marks, type, apiKey });
                    } catch (err) {
                        console.error('AI generation failed:', err);
                        showNotification('‚ö†Ô∏è', 'AI unavailable', 'Falling back to template generation', 'warning');
                    }
                } else {
                    showNotification('‚ÑπÔ∏è', 'No API Key', 'Using template-based generation. Add your OpenAI key for better results.', 'info');
                }

                if (!qa) {
                    // Fallback to legacy template generation
                    const question = generateQuestionForTopic(topic, marks, type);
                    const answer = generateAnswerForQuestion(question, marks, type, topic);
                    qa = { question, answer, type, marks, topic };
                }

                const formattedAnswer = composeAnswerText(qa, type);

                document.getElementById('display-question').textContent = qa.question || 'Question unavailable';
                document.getElementById('display-answer').textContent = formattedAnswer;
                document.getElementById('answers-qa-display').style.display = 'block';

                saveToAnswerSession(subject, topic, marks, type, qa.question, formattedAnswer);
                displayAnswerHistory(subject);

                showNotification('‚úÖ', 'Answer Generated', `Generated ${type.toUpperCase()} for ${marks} marks`, 'success');
            } finally {
                // Hide loading indicator
                loadingEl.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.style.opacity = '1';
                generateBtn.style.cursor = 'pointer';
            }
        }

        // Compose readable answer text (handles MCQ and long forms)
        function composeAnswerText(qa, type) {
            if (type === 'mcq') {
                const options = qa.options || [];
                const optionLines = options.map((opt, idx) => `${String.fromCharCode(65 + idx)}. ${opt}`).join('\n');
                const correct = qa.correctOption || qa.answer || '';
                const explanation = qa.explanation ? `\n\nExplanation: ${qa.explanation}` : '';
                return `Options:\n${optionLines}\n\nCorrect: ${correct}${explanation}`;
            }
            return qa.answer || 'Answer unavailable';
        }

        // Use OpenAI to generate question + answer tailored to marks/type
        async function generateAIQA({ subject, topic, marks, type, apiKey }) {
            const lengthHints = {
                1: { words: 25, bullets: 0 },
                2: { words: 60, bullets: 2 },
                4: { words: 120, bullets: 4 },
                5: { words: 150, bullets: 4 },
                10: { words: 220, bullets: 6 },
                15: { words: 300, bullets: 8 }
            };

            const hint = lengthHints[marks] || { words: 120, bullets: 4 };
            const isMCQ = type === 'mcq';

            const prompt = `Generate an exam-ready ${isMCQ ? 'multiple-choice question (MCQ)' : 'long-answer question'} for ${subject} on the topic "${topic}".
Marks: ${marks} mark(s).
Requirements:
- Difficulty: moderate, syllabus-aligned.
- Unambiguous wording.
- ${isMCQ ? 'Provide exactly 4 options labeled A, B, C, D. Only one correct.' : `Answer length about ${hint.words} words. Keep it tight.`}
- Tone: clear, instructional.
- Avoid fluff; focus on examinable points.

Return JSON ONLY in this shape:
{
  "question": "...",
  "type": "${isMCQ ? 'mcq' : 'long'}",
  ${isMCQ ? '"options": ["Option A", "Option B", "Option C", "Option D"], "correctOption": "Option X", "explanation": "Why this is correct in 2 sentences"' : '"answer": "The answer text"'}
}`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    temperature: 0.4,
                    max_tokens: 600,
                    messages: [
                        { role: 'system', content: 'You are a concise exam question setter. Always return VALID JSON only.' },
                        { role: 'user', content: prompt }
                    ]
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || `OpenAI error ${response.status}`);
            }

            const data = await response.json();
            const content = data.choices?.[0]?.message?.content || '';
            const jsonMatch = content.match(/```json\n([\s\S]*?)\n```/) || content.match(/````?\n([\s\S]*?)\n````?/);
            const jsonText = jsonMatch ? jsonMatch[1] : content;
            const parsed = JSON.parse(jsonText);

            if (!parsed.question) throw new Error('Invalid AI payload: missing question');
            if (isMCQ && (!parsed.options || parsed.options.length < 4 || !parsed.correctOption)) {
                throw new Error('Invalid AI payload: MCQ options/correctOption missing');
            }

            return parsed;
        }

        function generateQuestionForTopic(topic, marks, type) {
            const questions = {
                'Syllabus Topic 1': [
                    `Explain the fundamental concepts of this topic. (${marks} marks)`,
                    `Discuss the key principles involved in ${topic}. (${marks} marks)`,
                    `Analyze the applications of concepts in ${topic}. (${marks} marks)`
                ],
                'Syllabus Topic 2': [
                    `Compare and contrast the main theories in this field. (${marks} marks)`,
                    `What are the limitations of traditional approaches to ${topic}? (${marks} marks)`,
                    `Evaluate the significance of recent developments. (${marks} marks)`
                ],
                'Past Paper 1': [
                    `Solve the following problem based on ${topic} concepts. (${marks} marks)`,
                    `What are the common mistakes students make in ${topic}? (${marks} marks)`,
                    `Apply the concepts to a real-world scenario. (${marks} marks)`
                ],
                'Chapter 1': [
                    `Define the key terms from Chapter 1. (${marks} marks)`,
                    `Summarize the main ideas from this chapter. (${marks} marks)`,
                    `How does this chapter relate to previous topics? (${marks} marks)`
                ]
            };

            const genericQuestions = [
                `Explain the concept of ${topic} with relevant examples. (${marks} marks)`,
                `Discuss the importance and applications of ${topic}. (${marks} marks)`,
                `What are the key factors to consider in ${topic}? (${marks} marks)`,
                `Analyze the relationship between different aspects of ${topic}. (${marks} marks)`,
                `Compare ${topic} with other related concepts. (${marks} marks)`
            ];

            let questionPool = questions[topic] || genericQuestions;
            return questionPool[Math.floor(Math.random() * questionPool.length)];
        }

        function generateAnswerForQuestion(question, marks, type, topic) {
            const answerLength = {
                5: 'concise (100-150 words)',
                10: 'moderate (200-300 words)',
                15: 'detailed (400-500 words)',
                20: 'comprehensive (600-800 words)'
            };

            const structures = {
                long: [
                    `1. Introduction\n   - Define the concept\n   - State main points\n\n2. Body (3-4 paragraphs)\n   - Explain key aspects\n   - Provide examples\n   - Discuss implications\n\n3. Conclusion\n   - Summarize main points\n   - Link to broader context`,
                    `Key Points:\n   ‚Ä¢ First important aspect: Explanation with example\n   ‚Ä¢ Second aspect: Analysis and significance\n   ‚Ä¢ Third aspect: Application or implications\n   ‚Ä¢ Related concept: Connection to broader topic\n\nConclusion: Reinforce the importance of the topic`,
                    `Introduction: ${topic} is important because...\n\nMain Discussion:\n1. Definition and scope: ${topic} involves...\n2. Key characteristics: Notable features include...\n3. Real-world applications: Practical examples include...\n4. Comparative analysis: Unlike other approaches...\n\nConclusion: This demonstrates the significance of ${topic} in academic and professional contexts.`
                ],
                mcq: [
                    `Based on the definition and characteristics of ${topic}:\n\nThe correct answer is: [Option that aligns with the question]\n\nExplanation:\n- This option correctly identifies...\n- Key concepts involved: Definition, Application, Significance\n- Why other options are incorrect:\n  ‚Ä¢ Option A: Overlooks the fundamental aspect\n  ‚Ä¢ Option C: Misinterprets the concept\n  ‚Ä¢ Option D: Confuses with related but different concept`,
                    `Answer: [Correct Option]\n\nReasoning:\n${topic} specifically refers to...\nThis answer demonstrates understanding of:\n- The core definition\n- Key characteristics\n- Proper application of the concept\n\nCommon misconceptions addressed:\n- Many students confuse this with...\n- The difference lies in...`,
                ]
            };

            const answerType = type === 'mcq' ? 'mcq' : 'long';
            const template = structures[answerType][Math.floor(Math.random() * structures[answerType].length)];

            return `${template}\n\n[Answer Length: ${answerLength[marks] || 'detailed'} expected]`;
        }

        function saveToAnswerSession(subject, topic, marks, type, question, answer) {
            const user = getCurrentUser();
            if (!user) return;

            if (!user.answerSessions) {
                user.answerSessions = {};
            }
            if (!user.answerSessions[subject]) {
                user.answerSessions[subject] = [];
            }

            user.answerSessions[subject].push({
                topic,
                marks,
                type,
                question,
                answer,
                generatedAt: new Date().toLocaleString()
            });

            // Persist to localStorage
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === user.email);
            if (userIndex !== -1) {
                users[userIndex] = user;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem(`user_${user.email}`, JSON.stringify(user));
            }
        }

        function displayAnswerHistory(subject) {
            const user = getCurrentUser();
            if (!user || !user.answerSessions?.[subject]) {
                return;
            }

            const sessions = user.answerSessions[subject];
            const historyContent = document.getElementById('history-content');
            historyContent.innerHTML = '';

            sessions.forEach((qa, index) => {
                const card = document.createElement('div');
                card.className = 'bg-slate-900 border border-slate-600 rounded-lg p-4 text-slate-100';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-bold text-slate-100">Q${index + 1} ‚Ä¢ ${qa.marks} marks ‚Ä¢ ${qa.type.toUpperCase()}</span>
                        <span class="text-xs text-slate-400">${qa.generatedAt}</span>
                    </div>
                    <div class="mb-3 p-3 bg-slate-800 rounded border-l-4 border-blue-400">
                        <p class="text-sm font-semibold text-slate-50">${qa.question}</p>
                    </div>
                    <div class="p-3 bg-emerald-900 rounded border-l-4 border-emerald-400">
                        <p class="text-xs text-emerald-50 whitespace-pre-line">${qa.answer}</p>
                    </div>
                `;
                historyContent.appendChild(card);
            });

            document.getElementById('answers-history').style.display = 'block';
        }

        function openMarksEditor() {
            document.getElementById('marks-editor-modal').classList.add('active');
            const user = getCurrentUser();
            if (user?.customAnswerMarks) {
                document.getElementById('marks-input').value = user.customAnswerMarks.join(', ');
            }
        }

        function closeMarksEditor() {
            document.getElementById('marks-editor-modal').classList.remove('active');
        }

        function saveCustomMarks() {
            const input = document.getElementById('marks-input').value;
            const marks = input.split(',').map(m => {
                const parsed = parseInt(m.trim());
                return isNaN(parsed) ? null : parsed;
            }).filter(m => m !== null);

            if (marks.length === 0) {
                showNotification('‚ö†Ô∏è', 'Invalid Input', 'Please enter valid mark numbers', 'warning');
                return;
            }

            const user = getCurrentUser();
            if (user) {
                user.customAnswerMarks = marks;
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.email === user.email);
                if (userIndex !== -1) {
                    users[userIndex] = user;
                    localStorage.setItem('users', JSON.stringify(users));
                    localStorage.setItem(`user_${user.email}`, JSON.stringify(user));
                }
            }

            // Update marks buttons
            const container = document.getElementById('answers-marks-container');
            container.innerHTML = '';
            marks.forEach(mark => {
                const btn = document.createElement('button');
                btn.className = 'w-full px-4 py-3 bg-gray-100 rounded-lg hover:bg-gray-200';
                btn.textContent = `${mark} Marks`;
                btn.onclick = () => selectAnswerMarks(mark);
                container.appendChild(btn);
            });

            closeMarksEditor();
            showNotification('‚úÖ', 'Marks Updated', `Custom marks saved: ${marks.join(', ')}`, 'success');
        }

        function clearAnswerHistory() {
            // Show custom confirmation modal
            const overlay = document.getElementById('clear-confirm-overlay');
            const modal = document.getElementById('clear-confirm-modal');
            overlay.classList.add('show');
            modal.classList.add('show');
        }

        function cancelClearHistory() {
            const overlay = document.getElementById('clear-confirm-overlay');
            const modal = document.getElementById('clear-confirm-modal');
            overlay.classList.remove('show');
            modal.classList.remove('show');
        }

        function confirmClearHistory() {
            const subject = document.getElementById('answers-subject-select').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser || !subject) {
                return;
            }
            
            // SAFETY CHECK: Back up uploads and aiAnalysis BEFORE any modifications
            const uploadsBackup = JSON.parse(JSON.stringify(currentUser.uploads || {}));
            const aiAnalysisBackup = JSON.parse(JSON.stringify(currentUser.aiAnalysis || {}));
            const studyPlansBackup = JSON.parse(JSON.stringify(currentUser.studyPlans || {}));
            
            // ONLY clear answerSessions - NOTHING ELSE
            if (!currentUser.answerSessions) {
                currentUser.answerSessions = {};
            }
            currentUser.answerSessions[subject] = [];
            
            // RESTORE all backed up data to ensure nothing is lost
            currentUser.uploads = uploadsBackup;
            currentUser.aiAnalysis = aiAnalysisBackup;
            currentUser.studyPlans = studyPlansBackup;
            
            // Save to localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Also update users array - sync answerSessions only
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                // Preserve all existing user data, only update answerSessions
                if (!users[userIndex].answerSessions) {
                    users[userIndex].answerSessions = {};
                }
                users[userIndex].answerSessions[subject] = [];
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Hide history section from screen ONLY
            const historyEl = document.getElementById('answers-history');
            const qaDisplayEl = document.getElementById('answers-qa-display');
            
            if (historyEl) {
                historyEl.style.display = 'none';
                const historyContent = document.getElementById('history-content');
                if (historyContent) historyContent.innerHTML = '';
            }
            
            // Also hide the current Q&A display on screen ONLY
            if (qaDisplayEl) {
                qaDisplayEl.style.display = 'none';
                const displayQuestion = document.getElementById('display-question');
                const displayAnswer = document.getElementById('display-answer');
                if (displayQuestion) displayQuestion.textContent = '';
                if (displayAnswer) displayAnswer.textContent = '';
            }
            
            // Close modal
            cancelClearHistory();
            
            showNotification('üóëÔ∏è', 'Q&A History Cleared', 'Cleared from this screen. Your topics, uploads, and analysis remain safe.', 'success');
        }

        function downloadAnswerSessionPDF() {
            const subject = document.getElementById('answers-subject-select').value;
            const user = getCurrentUser();
            if (!subject || !user?.answerSessions?.[subject] || user.answerSessions[subject].length === 0) {
                showNotification('‚ö†Ô∏è', 'No Answers', 'Generate some answers first', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                showNotification('‚ùå', 'PDF Error', 'PDF library not loaded', 'error');
                return;
            }

            const doc = new jsPDF();
            let y = 20;

            // Title Page
            doc.setFontSize(20);
            doc.setTextColor(59, 130, 246); // Blue
            doc.text(`${subject} - Q&A Session`, 14, y);
            y += 10;

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, y);
            doc.text(`Total Questions: ${user.answerSessions[subject].length}`, 14, y + 6);
            y += 20;

            const sessions = user.answerSessions[subject];

            sessions.forEach((qa, index) => {
                // Add new page if needed
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }

                // Question number header with background
                doc.setFillColor(241, 245, 249); // Light gray background
                doc.rect(10, y - 5, 190, 10, 'F');
                doc.setFontSize(11);
                doc.setTextColor(51, 65, 85); // Dark gray
                doc.text(`Q${index + 1} ‚Ä¢ ${qa.marks} marks ‚Ä¢ ${qa.type.toUpperCase()}`, 14, y);
                doc.setFontSize(8);
                doc.setTextColor(148, 163, 184);
                doc.text(qa.generatedAt || new Date().toLocaleString(), 150, y);
                y += 12;

                // Question box with border
                doc.setDrawColor(59, 130, 246); // Blue border
                doc.setLineWidth(0.5);
                const questionLines = doc.splitTextToSize(qa.question, 175);
                const questionHeight = questionLines.length * 6 + 8;
                doc.rect(12, y - 2, 186, questionHeight);
                
                doc.setFontSize(9);
                doc.setTextColor(30, 58, 138); // Dark blue
                doc.text('Question:', 16, y + 3);
                
                doc.setFontSize(9);
                doc.setTextColor(0);
                let qY = y + 9;
                questionLines.forEach(line => {
                    doc.text(line, 16, qY);
                    qY += 6;
                });
                y = qY + 5;

                // Answer box with border
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }

                doc.setDrawColor(16, 185, 129); // Green border
                const answerLines = doc.splitTextToSize(qa.answer, 175);
                const answerHeight = Math.min(answerLines.length * 5 + 8, 100);
                doc.rect(12, y - 2, 186, answerHeight);
                
                doc.setFontSize(9);
                doc.setTextColor(5, 150, 105); // Dark green
                doc.text('Answer:', 16, y + 3);
                
                doc.setFontSize(8);
                doc.setTextColor(0);
                let aY = y + 9;
                answerLines.forEach((line, idx) => {
                    if (aY > 280) {
                        doc.addPage();
                        aY = 20;
                    }
                    doc.text(line, 16, aY);
                    aY += 5;
                });
                y = aY + 10;

                y += 8;
            });
            
            // Footer on last page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Bharat Academic Copilot - Exam Intelligence', 105, 285, { align: 'center' });
            }
            
            doc.save(`AnswerSession_${subject}_${new Date().toISOString().slice(0, 10)}.pdf`);
            showNotification('üì•', 'Session Downloaded', 'Your Q&A session PDF has been saved', 'success');
        }

        function initAnswers() {
            populateAnswersSubjects();

            const subjectSelect = document.getElementById('answers-subject-select');
            if (subjectSelect && !subjectSelect.__wired) {
                subjectSelect.addEventListener('change', function() {
                    const subject = this.value;
                    localStorage.setItem('answersLastSubject', subject);
                    populateAnswersTopics(subject);
                    displayAnswerHistory(subject);
                });
                subjectSelect.__wired = true;
            }

            // Restore last subject if available
            const lastSubject = localStorage.getItem('answersLastSubject');
            if (lastSubject && subjectSelect && Array.from(subjectSelect.options).some(o => o.value === lastSubject)) {
                subjectSelect.value = lastSubject;
                populateAnswersTopics(lastSubject);
                displayAnswerHistory(lastSubject);
            }

            // Initialize with custom marks if available
            const user = getCurrentUser();
            if (user?.customAnswerMarks) {
                const container = document.getElementById('answers-marks-container');
                container.innerHTML = '';
                user.customAnswerMarks.forEach(mark => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full px-4 py-3 bg-gray-100 rounded-lg hover:bg-gray-200';
                    btn.textContent = `${mark} Marks`;
                    btn.onclick = () => selectAnswerMarks(mark);
                    container.appendChild(btn);
                });
            }
        }

        function initPlanner() {
            populatePlannerSubjects();
            updatePlannerDaysLeft();
            const select = document.getElementById('planner-subject-select');
            if (select && !select.__wired) {
                select.addEventListener('change', function() {
                    const subject = this.value;
                    // Persist last selected subject
                    localStorage.setItem('plannerLastSubject', subject);
                    renderPlannerMetrics(subject);
                    renderPlannerSessions(subject);
                    renderPlannerTimetable(subject);
                });
                select.__wired = true;
            }
            // Restore last subject if available and valid
            const last = localStorage.getItem('plannerLastSubject');
            if (last && select && Array.from(select.options).some(o => o.value === last)) {
                select.value = last;
            }
            const subject = document.getElementById('planner-subject-select')?.value || '';
            if (subject) {
                renderPlannerMetrics(subject);
                renderPlannerSessions(subject);
                renderPlannerTimetable(subject);
            } else {
                renderPlannerMetrics('');
                renderPlannerSessions('');
                renderPlannerTimetable('');
            }
        }

        // Wire navigation
        function goToPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            if (page === 'planner') initPlanner();
            if (page === 'dashboard') initDashboard();
            if (page === 'analysis') initAnalysis();
            if (page === 'answers') initAnswers();
            if (page === 'upload') initUploadPage();
            if (window.innerWidth < 768) document.getElementById('sidebar').style.transform = 'translateX(-100%)';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.transform = sidebar.style.transform === 'translateX(-100%)' ? 'translateX(0)' : 'translateX(-100%)';
        }

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (window.innerWidth < 768) document.getElementById('sidebar').style.transform = 'translateX(-100%)';
            });
        });

        if (window.innerWidth >= 768) {
            document.getElementById('sidebar').style.transform = 'translateX(0)';
        } else {
            document.getElementById('sidebar').style.transform = 'translateX(-100%)';
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // Keep planner subjects fresh when planner page becomes active
        document.addEventListener('DOMContentLoaded', function() {
            const plannerPage = document.getElementById('planner');
            if (plannerPage) {
                const observer = new MutationObserver(function() {
                    if (plannerPage.classList.contains('active')) {
                        initPlanner();
                    }
                });
                observer.observe(plannerPage, { attributes: true, attributeFilter: ['class'] });
            }
        });
    </script>
</body>
</html>
